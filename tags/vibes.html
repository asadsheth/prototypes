<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta property="og:title" content="doop doop doop" />
    <meta property="og:type" content="article" />
    <meta property="og:image" content="<?php echo $OG_IMAGE_BORROWED; ?>" />
	<style>
@font-face{
    font-family: "Yahoo-Sans";
    src: url('https://s.yimg.com/cv/ae/default/171027/Yahoo_Sans_Web_Fonts_170914/Yahoo_Sans-Regular.woff2');
    font-weight: normal;
    font-style: normal;
}
@font-face{
    font-family: "Yahoo-Sans";
    src: url('https://s.yimg.com/cv/ae/default/171027/Yahoo_Sans_Web_Fonts_170914/Yahoo_Sans-Light.woff2');
    font-weight: lighter;
    font-style: normal;
}
@font-face{
    font-family: "Yahoo-Sans";
    src: url('https://s.yimg.com/cv/ae/default/171027/Yahoo_Sans_Web_Fonts_170914/Yahoo_Sans-Medium.woff2');
    font-weight: medium;
    font-style: normal;
}
@font-face{
    font-family: "Yahoo-Sans";
    src: url('https://s.yimg.com/cv/ae/default/171027/Yahoo_Sans_Web_Fonts_170914/Yahoo_Sans-Bold.woff2');
    font-weight: bold;
    font-style: normal;
}

* {
	box-sizing: border-box;
}
html, body {
	overflow-x: hidden;
}
body{
	color: #222;
	margin: 0;
	background: #ddd;
	font-family: Yahoo-Sans;
	font-size: 15px;
	max-width: 600px;
}

a {
	text-decoration: none;
	color: inherit;
}

div.vibe_button {
	font-size: 35px;
	/*margin: 35px;*/
	margin-bottom: 5px;
	background: white;
	padding: 35px;
	box-sizing: border-box;
	border: 2px outset;
}

h1.vibe_header	{
	text-align: center;
	background: linear-gradient(45deg, blue, purple);
	height: 200px;
	line-height: 200px;
	font-size: 30px;
	color: white;
}

div.card {
	margin: 0px 0px 25px 0px;
	padding: 20px 0px 20px 0px;
	border-bottom: 1px solid #777;
	border-top: 1px solid #ccc;
	background: white;
	box-shadow: 0 0 20px 0 gray;
}

div.prompt {
	/* this is the thing that somebody says, e.g. the comment */
	border: 5px solid purple;
	border-width: 0px 0px 0px 5px;
}
div.card_meta {
	/*border-left: 5px solid;*/
	padding: 0 0 0 0px;
}

div.card_author {
	padding: 0px 20px;
	font-size: 12px;
	font-weight: bold;
}
div.card_author_avatar img {
	float: left;
	width: 25px;
	height: 25;
	border-radius: 13px;
	box-shadow: 0 0 10px 0 gray;
	margin-right: 10px;
}
div.card_author_avatar {

}
div.card_author_name {

}
div.card_timestamp {
	font-size: 10px;
	color: gray;
	padding: 0px 20px 0px 20px;
}

div.premise {
	padding: 0px 0px 0px 00px;
	margin: 20px 20px;
	border-radius: 15px;
	background: linear-gradient(#eee, #ddd);
	padding: 15px;
	white-space: pre-wrap;
	/*border-left: 5px solid purple;*/
}

div.riposte {
	margin-left: 20px;
	border: 5px solid purple;
	border-width: 0px 0px 0px 5px;	
}

div.context {
}
div.verbose {
	margin-top: -20px;
	margin-bottom: 20px;
}
div.context div.context_title {
	font-weight: bold;
	padding: 0px 20px;
	margin: 20px 0px 10px 0px;
	font-size: 30px;
}
div.context div.context_source {
	font-weight: normal;
	padding: 0px 20px;
	margin: 0px 0px;
	font-size: 10px;
}
img.context_image {
	width: 100%;
}

div.engagement {
	padding: 0px 20px;
	margin: 20px 0px;
	text-align: right;
	font-size: 10px;
}

div.reply {
	padding: 20px;
}
div.reply textarea {
	width: 100%;
	height: 59px;
	border: 1px solid gray;
	font-size: 14px;
	padding: 20px;
}

div.clear	{
	visibility: hidden;
	height: 0px;
	overflow: hidden;
	clear: both;
}
	</style>

</head>

<body>

</body>

<script>
console.log('[no params]: new vibe stream, re-ranked with timesteps');
console.log('?evaluate: browse full comment set for vibes');
console.log('?allcomments: dump every single comment i know');
console.log('?rawrank: new vibe stream but legacy ranking');
console.log('?cardstream: in progress');
console.log('?multiposters: in progress');
console.log('&noreplies: hides replies');
console.log('&threadsonly: hides items with no replies');
console.log('-------------------');

var ALL_VIBES = [];
var GLOBALS = {};
var AMALGAM = [];
var FOLLOWS = JSON.parse(localStorage.getItem('myvibes')) || {};

var COLORS = [
    'darkred',
    'rebeccapurple',
    'darkgreen',
    'darkcyan',
    'darkblue',
    'darkgoldenrod',
    'darkslateblue',
    'indigo',
    'firebrick',
    'darkviolet',
    'green',
    'maroon',
    'darkmagenta',
    'midnightblue'
];
var SECONDARY_COLORS = [
    'red',
    'purple',
    'green',
    'cyan',
    'blue',
    'goldenrod',
    'slateblue',
    'blue',
    'orange',
    'violet',
    'darkgreen',
    'red',
    'magenta',
    'blue'
];

document.addEventListener("DOMContentLoaded", function(event) {
	if(window.location.href.indexOf('clearlocalstorage') > -1)	{
		localStorage.clear();
	}

	if(window.location.href.indexOf('allcomments') > -1)	{
		document.body.innerHTML = '';

		console.log('fetching allcomments')
		var scr = document.createElement('script');
		scr.src = 'caches/c_allvibes.jsonp';
		document.head.appendChild(scr);
	}
	else {
		// get vibes from cached list
		load_vibe_list();
	}
});

var create_prompt = function(prompt_obj, theme_color) {
	var prompt = document.createElement('div');
	prompt.className = 'prompt';
	if(theme_color) prompt.style.borderColor = theme_color;
	// prompt metadata
	var card_meta = document.createElement('div');
	card_meta.className = 'card_meta';
	var author = document.createElement('div');
	author.className = 'card_author';
	author.innerHTML = '<div class="card_author_avatar"><img src="' + prompt_obj.author_img + '"/></div>' + '<div class="card_author_name">' + '<a target="_blank" href="userhistory.php?guid=' + prompt_obj.author_guid + '">' + prompt_obj.author_name + '</a>' + '</div>';
	card_meta.appendChild(author);
	
	// timestamp
	var timestamp = document.createElement('div');
	timestamp.className = 'card_timestamp';
	// comment time
	timestamp.innerHTML = prompt_obj.comment_relative_time + 'h';
	card_meta.appendChild(timestamp);
	prompt.appendChild(card_meta)
	// the premise of the comment
	if(prompt_obj.bot)	{
		// no!
	}
	else {
		var premise = document.createElement('div');
		premise.className = 'premise';
		premise.innerHTML = prompt_obj.text;
		prompt.appendChild(premise);
	}
	// engagement
	prompt.appendChild(create_engagement_meta(prompt_obj));

	return prompt;
}

var create_riposte = function(riposte_obj, theme_color)	{
	var riposte = document.createElement('div');
	if(theme_color) riposte.style.borderColor = theme_color;

	riposte.className = 'riposte';
	// riposte metadata
	var riposte_meta = document.createElement('div');
	riposte_meta.className = 'card_meta';
	var riposte_author = document.createElement('div');
	riposte_author.className = 'card_author';
	riposte_author.innerHTML = '<div class="card_author_avatar"><img src="' + riposte_obj.author_img + '"/></div>' + '<div class="card_author_name">' + riposte_obj.author_name + '</div>';
	riposte_meta.appendChild(riposte_author);
	var riposte_timestamp = document.createElement('div');
	riposte_timestamp.className = 'card_timestamp';
	// comment time
	riposte_timestamp.innerHTML = riposte_obj.comment_relative_time + 'h';
	riposte_meta.appendChild(riposte_timestamp);
	riposte.appendChild(riposte_meta)

	// the premise of the comment
	var riposte_premise = document.createElement('div');
	riposte_premise.className = 'premise';
	riposte_premise.innerHTML = riposte_obj.text;
 	riposte.appendChild(riposte_premise);

	// engagement
	riposte.appendChild(create_engagement_meta(riposte_obj)); 	

 	return riposte;
}

var create_engagement_meta = function(engagement_obj)	{
	var engagement = document.createElement('div');
	engagement.className = 'engagement';
	engagement.innerHTML = '&uarr; ' + engagement_obj.upvotes + '&nbsp; &nbsp; &nbsp; ' + '&darr; ' + engagement_obj.downvotes + '&nbsp; &nbsp; &nbsp; ' + '&#10150; ' + engagement_obj.replies;
	
	return engagement;
}

var create_context = function(context_obj, verbose, theme_color)	{
	if(verbose)	{
		var context = document.createElement('div');
		context.className = 'context verbose';
		context.innerHTML = '<a target="_blank" href="' + context_obj.context_meta.link + '">' + (context_obj.context_meta.img ? ('<img class="context_image" src="' + context_obj.context_meta.img + '"/>') : '') + '<div class="context_title">' + context_obj.context_meta.title + '</div>' + '<div class="context_source">' + context_obj.context_meta.provider + ' &bull; ' + context_obj.context_meta.content_relative_time + 'h' + '</div>' + '</a>';
	}
	else {
		// the context (the article)
		var context = document.createElement('div');
		context.className = 'context';
		context.style.background = '#eee';
		context.style.padding = '10px';
		context.innerHTML = '<div style="margin-left: 20px">' + context_obj.context_meta.vibe_name + ' &bull; ' + context_obj.context_meta.provider + ' &bull; ' + context_obj.context_meta.content_relative_time + 'h</div>' + '<a target="_blank" tabindex="-1" href="' + context_obj.context_meta.link + '">'  + '<div class="context_title" style="font-size: 16px !important; margin-top: 10px !important; margin-bottom: 10px !important">' + context_obj.context_meta.title + '</div>' + '</a>';
	}

	if(theme_color) {
		context.style.background = theme_color;
		context.style.color = '#fff';
	}

	return context;
}

function create_vibe_card(obj) {
	console.log('function: create_vibe_card();');

	// shortcuts
	var vibe_id = obj.id;
	var vibe_name = obj.name;
	var vibe_posts = obj.posts;
	var vibe_comments = obj.comments;
	var vibe_postscomments = obj.postscomments;
	
	// which list should we use to render stuff?
	var selected_list = vibe_postscomments;

	// what's the theme for this vibe
	var theme_color = COLORS[vibe_id.charCodeAt(1) % COLORS.length];
	var secondary_color = SECONDARY_COLORS[vibe_id.charCodeAt(1) % COLORS.length];

	var is_ntk = vibe_id == '@NTKVIDEO';
	// var is_mega = vibe_id == '@MEGASTREAMVIDEO';
	var is_mega = vibe_id == '@MEGASTREAM';

	var vibe_card = document.createElement('div');
	vibe_card.style.background = 'white';
	// vibe_card.style.boxShadow = '0 0 10px 0 rgba(0,0,0,0.5)'
	vibe_card.style.padding = '10px';
	vibe_card.style.margin = '0 0 20px 0';
	vibe_card.style.perspective = '1000px';
	
	var card_header = document.createElement('h1');
	card_header.innerHTML = vibe_name;
	card_header.style.margin = '0';
	card_header.style.display = 'inline-block'
	card_header.style.paddingBottom = '10px';
	card_header.style.borderBottom = '2px solid gray'
	card_header.style.borderColor = theme_color;
	// text gradient stuff
	card_header.style.background = '-webkit-linear-gradient(135deg, ' + secondary_color + ', ' + theme_color + ')';
	card_header.style.webkitBackgroundClip = 'text';
	card_header.style.webkitTextFillColor= 'transparent';
	vibe_card.appendChild(card_header);

	if(selected_list.length == 0) {
		var empty_message = document.createElement('div');
		empty_message.innerHTML = 'Nothing to see here lately.'
		empty_message.style.margin = '20px 0'
		vibe_card.appendChild(empty_message)
	}
	else {
		// use the selected list
		for(var j = 0; j < selected_list.length; j++)	{
			var vibe_story = document.createElement('div');
			vibe_story.className = 'vibe_story';

			var post_meta;
			// first figure out which list we're using and set the post meta accordingly
			if(selected_list == vibe_postscomments) 
				post_meta = selected_list[j].context_meta;
			else 
				post_meta = selected_list[j];

			var has_thumbnail = post_meta.img;
			var has_vertical_thumbnail = has_thumbnail && (post_meta.imgw / post_meta.imgh == 9/16);
			var is_vertical_video = (post_meta.aspect == 0.56);
			has_vertical_thumbnail = is_vertical_video;
			var has_comment = false;

			if(
				selected_list == vibe_postscomments && !selected_list[j].bot
				// && !has_vertical_thumbnail // disable comments for vertical videos for now
				&& !is_ntk // disable comments for ntk for now
				// && !is_mega // disable comments for mega videos for now
				// && selected_list[j].score > 0.97
			) {
				// this one has a comment
				var comment_block = document.createElement('div');
				comment_block.fontWeight = 'normal'
				comment_block.innerHTML = '<div style="color: #888; font-size: 11px; margin-bottom: 5px; vertical-align: middle">' + '<img style="width: 20px; height: 20px; border-radius: 10px; position: relative; margin-right: 6px" src="' + selected_list[j].author_img + '"/>' + '<span style="position: relative; top: -6px">' + selected_list[j].author_name + ' &bull; ' + ((selected_list[j].comment_relative_time > 0) ? (selected_list[j].comment_relative_time + 'h') : ('<span style="color: red">new</span>')) + '</span>' + '</div>' + '<div style="position: relative; margin-bottom: 20px; border-left: 5px solid ' + theme_color + '; padding: 0px 20px">' + selected_list[j].text + '</div>';
				vibe_story.appendChild(comment_block);

				// add the quote thinger
				var quote_bg = document.createElement('div');
				quote_bg.style.background = 'url(https://d30y9cdsu7xlg0.cloudfront.net/png/19279-200.png)';
				quote_bg.style.backgroundRepeat = 'no-repeat'
				quote_bg.style.backgroundSize = '100px';
				quote_bg.style.backgroundPosition = '0% 100%';
				quote_bg.style.opacity = 0.1;
				quote_bg.style.transform = 'rotate(180deg)';
				quote_bg.style.position = 'absolute';
				quote_bg.style.position = 'absolute';
				quote_bg.style.top = 0;
				quote_bg.style.left= 0;

				quote_bg.style.width = '100%';
				quote_bg.style.height = '100%';
				vibe_story.appendChild(quote_bg);

				has_comment = true;
			}

			// skip ntks that are missing thumbs. should never happen
			if(is_ntk && !has_thumbnail) continue;

			vibe_story.style.margin = is_ntk ? '20px 0 -10px 0' : (has_comment ? '20px -20px' : '20px 0');
			vibe_story.style.padding = has_comment ? '20px 20px' : '';
			vibe_story.style.background = has_comment ? '#f9f9f9' : '';
			vibe_story.style.position = 'relative';
			// vibe_story.style.boxShadow = has_comment ? '0 0 3px 0px rgba(0,0,0,0.5) inset' : '';		
			vibe_story.url = post_meta.post_url;
			vibe_story.onclick = function() {
				window.open(this.url)
			}

			if(
				has_thumbnail
				// && !has_comment
			)	{
				var vibe_story_img = document.createElement('div');
				vibe_story_img.style.display = 'inline-block'
				vibe_story_img.className = 'vibe_story_img';
				vibe_story_img.style.borderRadius = is_ntk ? '10px' : '5px';
				vibe_story_img.style.width = is_ntk ? '100%' : (has_comment ? '46px' : '82px');
				vibe_story_img.style.height = is_ntk ? (Math.floor(300 + (Math.random() * 300)) + 'px') : (has_vertical_thumbnail ? (has_comment ? '84px' : '136px') : (has_comment ? '46px' : '82px'));
				vibe_story_img.style.margin = is_ntk ? '0px 0px 10px 0px' : '0';
				vibe_story_img.style.marginLeft = is_ntk ? '' : '';
				vibe_story_img.style.boxShadow = is_ntk ? '0 0 10px 0 gray' : ''; // dropp because of perf
				vibe_story_img.style.background = 'url(' + ((is_ntk || has_vertical_thumbnail) ? post_meta.img : post_meta.imgresolutions[0].url) + ') no-repeat center center';
				vibe_story_img.style.backgroundSize = 'cover'
				vibe_story.appendChild(vibe_story_img);
			}
					
			var vibe_story_provider = document.createElement('div');
			vibe_story_provider.style.display = 'inline-block'
			vibe_story_provider.style.fontSize = '10px'
			vibe_story_provider.innerHTML = post_meta.provider;

			var vibe_story_timestamp = document.createElement('div');
			vibe_story_timestamp.style.display = 'inline-block'
			vibe_story_timestamp.style.fontSize = '10px'
			vibe_story_timestamp.innerHTML = '&nbsp; &bull; ' + (post_meta.content_relative_time == 0 ? ('<font style="color: red">new</font>') : (post_meta.content_relative_time > 23) ? (Math.floor(post_meta.content_relative_time / 24) + 'd') : (post_meta.content_relative_time + 'h'));

			var vibe_story_title = document.createElement('div');
			vibe_story_title.style.fontSize = is_ntk ? '30px' : has_vertical_thumbnail ? (has_comment ? '14px' : '24px') : (has_comment ? '13px' : '15px');
			vibe_story_title.style.fontWeight = is_ntk ? 'bold' : 'normal';
			vibe_story_title.style.color = is_ntk ? 'white' : (has_comment ? '#444' : '#222');
			vibe_story_title.style.webkitLineClamp = has_vertical_thumbnail ? '4' : (has_comment ? '2' : '3');
			vibe_story_title.style.display = '-webkit-box';
			vibe_story_title.style.overflow = 'hidden';
			vibe_story_title.style.webkitBoxOrient= 'vertical';
			vibe_story_title.style.textShadow = is_ntk ? '1px 1px 10px black' : '';
			vibe_story_title.innerHTML = post_meta.title;

			var vibe_story_actions = document.createElement('div');
			vibe_story_actions.style.fontSize = '10px';
			vibe_story_actions.style.margin = '5px 0px';
			vibe_story_actions.style.color = theme_color;
			vibe_story_actions.innerHTML = post_meta.reaction_count ? (post_meta.reaction_count > 1 ? post_meta.reaction_count + ' reactions' : post_meta.reaction_count + ' reaction') : '' ;

			var vibe_story_meta = document.createElement('div');
			vibe_story_meta.style.paddingLeft = (!is_ntk && has_thumbnail) ? '10px' : '';
			vibe_story_meta.style.display = 'inline-block';
			vibe_story_meta.style.color = '#aaa';
			vibe_story_meta.style.width = (has_thumbnail) ? '70%' : '100%';
			vibe_story_meta.style.verticalAlign = 'top';

			if(is_ntk) {
				// vibe_story_meta.appendChild(vibe_story_provider)
				// vibe_story_meta.appendChild(vibe_story_timestamp)
				vibe_story_meta.appendChild(vibe_story_title)			
				// vibe_story_meta.appendChild(vibe_story_actions)
				vibe_story_img.style.position = 'relative';
				vibe_story_meta.style.position = 'absolute';
				vibe_story_meta.style.bottom = '0';
				vibe_story_meta.style.left = '0';
				vibe_story_meta.style.width = '100%';
				vibe_story_meta.style.padding = '50px 20px 15px 20px';
				vibe_story_meta.style.textAlign = 'left';
				vibe_story_meta.style.background = 'linear-gradient(rgba(0, 0, 0, 0), rgba(0,0,0,0.75))';
				vibe_story_meta.style.borderRadius = '10px';
				vibe_story_img.appendChild(vibe_story_meta);

			} else {
				vibe_story_meta.appendChild(vibe_story_provider)
				vibe_story_meta.appendChild(vibe_story_timestamp)
				vibe_story_meta.appendChild(vibe_story_title)			
				vibe_story_meta.appendChild(vibe_story_actions)
				vibe_story.appendChild(vibe_story_meta);
			}

			// click behavior
			// vibe_story.onclick = function() {
				// do something
			// }

			// hide the leftovers until they hit read more
			if(
				(is_ntk && j > 2)
				|| 
				(!is_ntk && j > 3)
			) {
				vibe_story.style.display = 'none';
			}

			// append it to the card
			vibe_card.appendChild(vibe_story);
		}

		if(!is_ntk) {
			var vibe_card_extender = document.createElement('div');
			vibe_card_extender.style.textAlign = 'left';
			
			var vibe_card_more_button = document.createElement('button');
			vibe_card_more_button.style.border = 'none';
			vibe_card_more_button.style.background = 'none';
			vibe_card_more_button.style.color = '#666';
			vibe_card_more_button.style.padding = '10px 0px';
			vibe_card_more_button.innerHTML = selected_list.length > 3 ? 'Read more' : 'That\'s all for now';
			// handler for when people ask for more
			if(selected_list.length > 3) {
				vibe_card_more_button.onclick = function() {
					var vibe_card = this.parentNode.parentNode;

					// unhide all the hidden stories
					for(var i = 0; i < vibe_card.childNodes.length; i++) {
						if(vibe_card.childNodes[i].className == 'vibe_story') {
							vibe_card.childNodes[i].style.display = 'block';
						}
					}

					// hide the read more thinger
					this.parentNode.style.display = 'none';
				}
			}
			vibe_card_extender.appendChild(vibe_card_more_button);

			if(vibe_id.indexOf('@') == -1)	{
				var vibe_card_unsubscribe_button = document.createElement('button');
				vibe_card_unsubscribe_button.style.border = 'none';
				vibe_card_unsubscribe_button.style.border = 'none';
				vibe_card_unsubscribe_button.style.background = 'none';
				vibe_card_unsubscribe_button.style.color = '#666';
				vibe_card_unsubscribe_button.style.padding = '10px 0px';
				vibe_card_unsubscribe_button.innerHTML = '&nbsp; &bull; &nbsp; Unsubscribe';
				// handler for when people ask for more
				vibe_card_unsubscribe_button.vibe_id = vibe_id;
				vibe_card_unsubscribe_button.onclick = function() {
					// update followed vibes
					var vibes = JSON.parse(localStorage.getItem('myvibes')) || {};
					delete vibes[this.vibe_id];
					localStorage.setItem('myvibes', JSON.stringify(vibes));
					
					// hide the more actions thinger
					this.innerHTML = '&nbsp; &bull; &nbsp; Got it! We won\'t show this to you anymore.';

					// unfocus the button
					this.blur();
				}
				vibe_card_extender.appendChild(vibe_card_unsubscribe_button);
			}

			vibe_card.appendChild(vibe_card_extender);

		}
	}

	return vibe_card;	
}

function load_vibe_list() {
	console.log('function: load_vibe_list(); gets the list of available vibes')
	// add script to head for jsonp to load the list of vibes that are available for analysis. this function will not get run on pages that parse amalgams and spit it out - it's just for pages that need a menu of vibes
	var scr = document.createElement('script');
	scr.src = 'caches/all_vibes.jsonp';
	document.head.appendChild(scr);
}

function load_vibe(id) {
	console.log('function: load_vibe(); getting details for the individual vibe, conditional on page params');
	// load an individual vibe. first check if we're evaluating all comments for each vibe or if we're looking at a pseudovibestream based on comments or if we're just spitting out the raw ranking
	if(window.location.href.indexOf('evaluate') > -1)	{
		// we're just evaluating all the comments we have for this vibe
		var scr = document.createElement('script');
		scr.src = 'caches/c_full_' + id + '.jsonp';
		document.head.appendChild(scr);
	}
	else if(window.location.href.indexOf('rawrank') > -1) {
		// spit out the raw list the backend gave us
		var scr = document.createElement('script');
		scr.src = 'caches/c_rawrank_' + id + '.jsonp';
		document.head.appendChild(scr);		
	}
	else {
		// we're looking at our new ranked pseudo-stream
		var scr = document.createElement('script');
		scr.src = 'caches/c_' + id + '.jsonp';
		document.head.appendChild(scr);
	}
}

function jsonp_parse_all_comments(obj) {
	console.log('function: jsonp_parse_all_comments(); handling the full list of comments' );
	document.title = 'evaluate all comments';		
	console.log(obj);
	
	// in this function we're getting as an input alllll the comments we found
	document.body.className = 'vibe_comment_evaluator';

	for(var i = 0; i < obj.length; i++)	{
		// skip bot posts
		if(obj[i].bot) continue;
		// skip reply-less comments if we're in threadsonly mode
		if(
			window.location.href.indexOf('threadsonly') > -1
			&& !obj[i].ripostes
		) continue;

	    var theme_color = COLORS[obj[i].context_meta.vibe_id.charCodeAt(1) % COLORS.length];

		var card = document.createElement('div');
		card.className = 'card';

		// the prompt (the comment)
		card.appendChild(create_prompt(obj[i], theme_color));
		// existing riposte
		if(
			obj[i].ripostes
			&& window.location.href.indexOf('noreplies') == -1
		)	{
			card.appendChild(create_riposte(obj[i].ripostes, theme_color));
		}		

		// the reply entry field
		// var reply = document.createElement('div');
		// reply.className = 'reply';
		// reply.innerHTML = '<textarea placeholder="' + (obj[i].bot ? ('Start the conversation') : ('Reply to ' + obj[i].author_name)) + '&hellip;"></textarea>';
		// card.appendChild(reply);

		// the context
		card.appendChild(create_context(obj[i], false, theme_color));

		document.body.appendChild(card);
	}	
}

function jsonp_parse_comment_list(obj) {
	document.title = 'evaluate vibe comments';	
	console.log('function: jsonp_parse_comment_list(); looks at all the comments from a particular vibe');
	console.log(obj);

	// in this function we're just evaluating all the comments for a given vibe
	document.body.className = 'vibe_comment_evaluator';

	console.log(obj)

	for(var i = 0; i < obj.length; i++)	{
		// TODO - don't need to do this repeatedly for the same vibe
		var theme_color = COLORS[obj[i].context_meta.vibe_id.charCodeAt(1) % COLORS.length];    
		// skip bot posts
		if(obj[i].bot) continue;

		// skip reply-less comments if we're in threadsonly mode
		if(
			window.location.href.indexOf('threadsonly') > -1
			&& !obj[i].ripostes
		) continue;

		// the card
		var card = document.createElement('div');
		card.className = 'card';
		
		// the prompt
		card.appendChild(create_prompt(obj[i], theme_color));
		
		// existing riposte
		if(
			obj[i].ripostes
			&& window.location.href.indexOf('noreplies') == -1
		)	{
			card.appendChild(create_riposte(obj[i].ripostes, theme_color));
		}		
		
		// the context (the article)
		card.appendChild(create_context(obj[i], false, theme_color));

		// the whitelist button
		var whitelist_div = document.createElement('div');
		whitelist_div.style.padding = '20px';
		whitelist_div.style.textAlign = 'center';
		var whitelist_button = document.createElement('button');
		whitelist_button.style.boxSizing = 'border-box';
		whitelist_button.style.background = theme_color;
		whitelist_button.style.padding = '20px';
		whitelist_button.style.color = 'white';
		whitelist_button.innerHTML = 'whitelist this comment for this vibe';
		whitelist_button.comment_data = obj[i];
		whitelist_button.onclick = function() {
			console.log(this.comment_data);
		}
		whitelist_div.appendChild(whitelist_button);
		// card.appendChild(whitelist_div);

		document.body.appendChild(card);
	}
}

function jsonp_parse_multi_posters(obj) {
	document.title = 'multi-posters';
	console.log('handler: multi-poster list NOT YET IMPLEMENTED');
	console.log(obj);
}

function jsonp_parse_amalgam(obj) {
	document.title = 'cardstream';	
	console.log('handler: amalgam cardstream');
	console.log(obj);
	AMALGAM = obj;

	// get followed vibes
	var followed_vibes = FOLLOWS;

	// styles
	document.body.style.background = '#fff';

	// first paint mine + trending
	for(var i = 0; i < obj.length; i++)	{
		var vibe_id = obj[i].id;
		var vibe_name = obj[i].name;
		var vibe_posts = obj[i].posts;
		var theme_color = COLORS[vibe_id.charCodeAt(1) % COLORS.length];

		var is_ntk = vibe_id == '@NTKVIDEO';
		// var is_mega = vibe_id == '@MEGASTREAMVIDEO';
		var is_mega = vibe_id == '@MEGASTREAM';
		var is_breaking = vibe_id == '@BREAKING';

		if(is_breaking) {
			// it's breaking news!
			var	breaking_card = document.createElement('div');
			breaking_card.style.fontSize = '36px';
			breaking_card.style.padding = '30px 10px';
			breaking_card.style.color = 'white';
			breaking_card.style.textShadow = '1px 1px 10px black';	
			breaking_card.style.background = 'linear-gradient(135deg, red, darkorange)';
			breaking_card.innerHTML = obj[i].title + '<br/>' + obj[i].msg;
			// document.body.appendChild(breaking_card);
		}
		else if(
			is_ntk
			|| is_mega
		)	{
			// it's an NTK or a MEGASTREAM or a regular vibe
			document.body.appendChild(create_vibe_card(obj[i]));
		}
		else if(followed_vibes[vibe_id]) {
			// it's a followed vibe
			document.body.appendChild(create_vibe_card(obj[i]));
		}
	}

	// now paint the suggested vibes carousel
	document.body.appendChild(create_suggested_vibes_card(followed_vibes));
}

function create_suggested_vibes_card(followed_vibes) {
	var theme_color = COLORS["Add to your Newsroom".charCodeAt(1) % COLORS.length]
	var secondary_color = SECONDARY_COLORS["Add to your Newsroom".charCodeAt(1) % COLORS.length]
	var suggested_vibes = document.createElement('div');
	suggested_vibes.style.background = 'white';
	// suggested_vibes.style.boxShadow = '0 0 10px 0 rgba(0,0,0,0.5)'
	suggested_vibes.style.padding = '10px';
	suggested_vibes.style.margin = '10px 0';
	
	var card_header = document.createElement('h1');
	card_header.innerHTML = 'Get more cards';
	card_header.style.margin = '0';
	card_header.style.display = 'inline-block'
	card_header.style.paddingBottom = '10px'
	card_header.style.marginBottom = '10px'
	card_header.style.borderBottom = '2px solid gray'
	card_header.style.borderColor = theme_color;
	card_header.style.background = '-webkit-linear-gradient(135deg, ' + secondary_color + ', ' + theme_color + ')';
	card_header.style.webkitBackgroundClip = 'text';
	card_header.style.webkitTextFillColor= 'transparent';
	suggested_vibes.appendChild(card_header);
	
	var merchandised_vibes = 0;
	var attempted_selections = 0;
	var merchandised_vibes_list = {};

	for(var i = 0; (i < ALL_VIBES.length) && (merchandised_vibes < 6) && attempted_selections < 100; i++)	{
		attempted_selections++;

		var random_index = Math.floor(Math.random() * ALL_VIBES.length);

		// check if i already followed it
		if(followed_vibes[ALL_VIBES[random_index].id]) continue;

		// skip specials like NTK and megastream
		if(ALL_VIBES[random_index].id.indexOf('@') > -1) continue;

		// see if we did it already
		if(merchandised_vibes_list[ALL_VIBES[random_index].id]) continue;		

		// OK WE'RE GONNA DO IT

		// note we did it already
		merchandised_vibes_list[ALL_VIBES[random_index].id] = true;

		// things to keep track of
		var vibe_id = ALL_VIBES[random_index].id;
		var vibe_name = ALL_VIBES[random_index].name;
		var vibe_desc = ALL_VIBES[random_index].meta ? ALL_VIBES[random_index].meta.description : '?';
		var vibe_img = ALL_VIBES[random_index].meta ? ALL_VIBES[random_index].meta.image.originalUrl : '';
		var vibe_subs = ALL_VIBES[random_index].meta ? ALL_VIBES[random_index].meta.userSubscriberCount : '?';
		var theme_color = COLORS[vibe_id.charCodeAt(1) % COLORS.length]
		
		var vibe_card = document.createElement('div');
		vibe_card.style.width = '50%';
		vibe_card.style.verticalAlign = 'top';
		vibe_card.style.display = 'inline-block';
		vibe_card.style.color = '#222';
		vibe_card.innerHTML = '<div style="position: relative; line-height: 18px; height: 220px; text-align: left; font-weight: bold; vertical-align: top; border-radius: 10px; margin: 10px 10px 0 0; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; padding: 140px 10px 10px 10px; display: -webkit-box; background: -webkit-linear-gradient(135deg, #333, ' + theme_color + '); -webkit-background-clip: text; -webkit-text-fill-color: transparent">' + /*'<img style="width: 100%" src="' + vibe_img + '" />' + */ '<div style="position: absolute; top: 0; left: 0; width: 100%; height: 130px; margin: 0; background-size: cover; background-position: 50% 50%; background-image: url(' + ALL_VIBES[random_index].meta.image.resolutions[0].url + ');"></div>' + '<div>' + vibe_name + '</div>' + '<div style="font-weight: normal; text-align: left">' + (vibe_desc || '?') + '</div>' + '<div style="height: 15px; position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(rgba(255,255,255,0), white); height: 50px"></div>' + '</div>';
		vibe_card.firstChild.vibe_id = vibe_id;
		vibe_card.firstChild.onclick = function() {
			this.style.webkitBackgroundClip = '';
			this.parentNode.style.color = 'white';
			this.style.webkitTextFillColor = '';

			ui_add_vibe_card(this.vibe_id);

			var vibes = JSON.parse(localStorage.getItem('myvibes')) || {};
			vibes[this.vibe_id] = 1;
			localStorage.setItem('myvibes', JSON.stringify(vibes));
		}
		
		suggested_vibes.appendChild(vibe_card);
		merchandised_vibes++;
	}

	if(merchandised_vibes == 0)	{
		var empty_message = document.createElement('div');
		empty_message.innerHTML = 'You\'ve exhausted our universe!';
		empty_message.style.margin = '20px 0'
		suggested_vibes.appendChild(empty_message)
	}

	return suggested_vibes;	
}

function ui_add_vibe_card(vibe_id) {
	console.log('adding an explicit follow');

	for(var i = 0; i < AMALGAM.length; i++)	{
		if(vibe_id == AMALGAM[i].id)	{
			// add it!
			var vibe_card = create_vibe_card(AMALGAM[i]);
			document.body.appendChild(vibe_card);
			window.scrollTo({
				'behavior' : 'smooth',
				'left' : '0',
				'top' : vibe_card.offsetTop
			});
		}
	}
}

function jsonp_parse_vibes(obj)	{
	document.title = 'vibe list';	
	console.log('function: jsonp_parse_vibes(); handles the vibe list');
	console.log(obj);

	// store it in the global
	ALL_VIBES = obj;

	// special prototype for card streams?
	if(window.location.href.indexOf('cardstream') > -1) {
		document.body.innerHTML = '';

		console.log('config: cardstream');
		var scr = document.createElement('script');
		scr.src = 'caches/amalgam.jsonp?rand=' + Math.random();
		document.head.appendChild(scr);
	}
	else if(window.location.href.indexOf('multiposters') > -1)	{
		document.body.innerHTML = '';

		console.log('config: multiposter evaluation!');
		var scr = document.createElement('script');
		scr.src = 'caches/multi_posters.jsonp';
		document.head.appendChild(scr);

		// ^ this is gonna end up calling: jsonp_parse_multi_posters
	}
	else {
		// here we're just handling the list of vibes - spit em out as a menu
		for(var i = 0; i < ALL_VIBES.length; i++)	{
			var vibe_button = document.createElement('div');
			vibe_button.className = 'vibe_button';
			vibe_button.id = ALL_VIBES[i].id;
			vibe_button.name = ALL_VIBES[i].name;
			vibe_button.innerHTML = ALL_VIBES[i].name;
			vibe_button.onclick = function() {
				document.body.innerHTML = '<h1 class="vibe_header">' + this.name + '</h1>';
				load_vibe(this.id);
			}

			document.body.appendChild(vibe_button);
		}
	}	

}

function jsonp_parse_posts(obj) {
	document.title = window.location.href.indexOf('rawrank') > -1 ? 'raw ranked new vibe stream' : 'new vibe stream';
	console.log('function: jsonp_parse_posts(); new vibe stream or rawranked vibe stream');
	console.log(obj);

	// this function tries our hand at a new vibe stream constructed by pseudoposts from comments
	for(var i = 0; i < obj.length; i++)	{
		// TODO - don't need to do this each time
		var theme_color = COLORS[obj[i].context_meta.vibe_id.charCodeAt(1) % COLORS.length];

		// the card
		var card = document.createElement('div');
		card.className = 'card';

		// the context (the article) and then the second param is verbose or not
		card.appendChild(create_context(obj[i], true));

		// the prompt (comment?)
		if(!obj[i].bot)	{
			var prompt = create_prompt(obj[i], theme_color);
			card.appendChild(prompt);
		}
	
		// ripostes
		// if(obj[i].ripostes)	{
			// card.appendChild(create_riposte(obj[i].ripostes));
		// }

		// the reply entry field
		// var reply = document.createElement('div');
		// reply.className = 'reply';
		// reply.innerHTML = '<textarea placeholder="' + (obj[i].bot ? ('Start the conversation') : ('Reply to ' + obj[i].author_name)) + '&hellip;"></textarea>';
		// card.appendChild(reply);

		document.body.appendChild(card);
	}
}

// function for auto refreshing the backend
var RELOAD_FREQ = 5; // in minutes
var reload_backend = function() {
	console.log('starting backend reload');
	var scr_elem = document.createElement('script');
	scr_elem.src = 'newvibesbot.php?rnad=' + Math.random();
	document.head.appendChild(scr_elem);

	// call me again in RELOAD_FREQ minutes
	setTimeout(reload_backend, RELOAD_FREQ * 60000);
}
// fire the auto-reloader?
if(
	window.location.href.indexOf('cardstream') > -1 
	&& window.location.href.indexOf('autoreload') > -1) {
	console.log('starting autoreloads');
	setTimeout(reload_backend, RELOAD_FREQ * 60000);
}
</script>

</html>