<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta property="og:title" content="doop doop doop" />
    <meta property="og:type" content="article" />
    <meta property="og:image" content="<?php echo $OG_IMAGE_BORROWED; ?>" />
	<style>
@font-face{
    font-family: "Yahoo-Sans";
    src: url('https://s.yimg.com/cv/ae/default/171027/Yahoo_Sans_Web_Fonts_170914/Yahoo_Sans-Regular.woff2');
    font-weight: normal;
    font-style: normal;
}
@font-face{
    font-family: "Yahoo-Sans";
    src: url('https://s.yimg.com/cv/ae/default/171027/Yahoo_Sans_Web_Fonts_170914/Yahoo_Sans-Light.woff2');
    font-weight: lighter;
    font-style: normal;
}
@font-face{
    font-family: "Yahoo-Sans";
    src: url('https://s.yimg.com/cv/ae/default/171027/Yahoo_Sans_Web_Fonts_170914/Yahoo_Sans-Medium.woff2');
    font-weight: medium;
    font-style: normal;
}
@font-face{
    font-family: "Yahoo-Sans";
    src: url('https://s.yimg.com/cv/ae/default/171027/Yahoo_Sans_Web_Fonts_170914/Yahoo_Sans-Bold.woff2');
    font-weight: bold;
    font-style: normal;
}

* {
	box-sizing: border-box;
}
html {
	/*overflow-x: hidden;*/
}
body{
	color: #222;
	margin: 0;
	background: #ddd;
	font-family: Yahoo-Sans;
	font-size: 15px;
	width: 100%;
}

a {
	text-decoration: none;
	color: inherit;
}

div.vibe_button {
	font-size: 35px;
	/*margin: 35px;*/
	margin-bottom: 5px;
	background: white;
	padding: 35px;
	box-sizing: border-box;
	border: 2px outset;
}

h1.vibe_header	{
	text-align: center;
	background: linear-gradient(45deg, blue, purple);
	height: 200px;
	line-height: 200px;
	font-size: 30px;
	color: white;
}

div.card {
	margin: 0px 0px 25px 0px;
	padding: 20px 0px 20px 0px;
	border-bottom: 1px solid #777;
	border-top: 1px solid #ccc;
	background: white;
	box-shadow: 0 0 20px 0 gray;
}

div.prompt {
	/* this is the thing that somebody says, e.g. the comment */
	border: 5px solid purple;
	border-width: 0px 0px 0px 5px;
}
div.card_meta {
	/*border-left: 5px solid;*/
	padding: 0 0 0 0px;
}

div.card_author {
	padding: 0px 20px;
	font-size: 12px;
	font-weight: bold;
}
div.card_author_avatar img {
	float: left;
	width: 25px;
	height: 25;
	border-radius: 13px;
	box-shadow: 0 0 10px 0 gray;
	margin-right: 10px;
}
div.card_author_avatar {

}
div.card_author_name {

}
div.card_timestamp {
	font-size: 10px;
	color: gray;
	padding: 0px 20px 0px 20px;
}

div.premise {
	padding: 0px 0px 0px 00px;
	margin: 20px 20px;
	border-radius: 15px;
	background: linear-gradient(#eee, #ddd);
	padding: 15px;
	white-space: pre-wrap;
	/*border-left: 5px solid purple;*/
}

div.riposte {
	margin-left: 20px;
	border: 5px solid purple;
	border-width: 0px 0px 0px 5px;	
}

div.context {
}
div.verbose {
	margin-top: -20px;
	margin-bottom: 20px;
}
div.context div.context_title {
	font-weight: bold;
	padding: 0px 20px;
	margin: 20px 0px 10px 0px;
	font-size: 30px;
}
div.context div.context_source {
	font-weight: normal;
	padding: 0px 20px;
	margin: 0px 0px;
	font-size: 10px;
}
img.context_image {
	width: 100%;
}

div.engagement {
	padding: 0px 20px;
	margin: 20px 0px;
	text-align: right;
	font-size: 10px;
}

div.reply {
	padding: 20px;
}
div.reply textarea {
	width: 100%;
	height: 59px;
	border: 1px solid gray;
	font-size: 14px;
	padding: 20px;
}

div.clear	{
	visibility: hidden;
	height: 0px;
	overflow: hidden;
	clear: both;
}

/* -------- newsroomish styles start here ---------*/
.cardstream_comment_block::after {
	content: "";
	background: url(https://d30y9cdsu7xlg0.cloudfront.net/png/19279-200.png);
	background-repeat: no-repeat;
	background-size: 100px;
	background-position: 0% 100%;
	opacity: 0.1;
	transform: rotate(180deg);
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;	
}

/* end newsroomish styles */
	</style>
	
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-111450274-1"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'UA-111450274-1');
	</script>

</head>

<body>

</body>

<script>
console.log('[no params]: new vibe stream, re-ranked with timesteps');
console.log('?evaluate: browse full comment set for vibes');
console.log('?allcomments: dump every single comment i know');
console.log('?rawrank: new vibe stream but legacy ranking');
console.log('?cardstream: in progress');
console.log('?multiposters: in progress');
console.log('&noreplies: hides replies');
console.log('&threadsonly: hides items with no replies');
console.log('&autoreload: periodically run newvibesbot.php');
console.log('&breaking: add a card for breaking news');
console.log('&useweblinks: link to www articles instead of newsroom posts');
console.log('&multinav: profile / home / explore');
console.log('&ntk: toggle the special ntk template; else it looks the same');
console.log('-------------------');

// holder global vars that will be used for stuff inside functions
var ALL_VIBES = [];
var AMALGAM = [];
var THREADLINES = {};

// cfg globals
var COLORS = [
    'darkred',
    'rebeccapurple',
    'darkgreen',
    'darkcyan',
    'darkblue',
    'darkgoldenrod',
    'darkslateblue',
    'indigo',
    'firebrick',
    'darkviolet',
    'green',
    'maroon',
    'darkmagenta',
    'midnightblue'
];
var SECONDARY_COLORS = [
    'red',
    'purple',
    'green',
    'cyan',
    'blue',
    'goldenrod',
    'slateblue',
    'blue',
    'orange',
    'violet',
    'darkgreen',
    'red',
    'magenta',
    'blue'
];
var CARDSTREAM_SCROLL_THROTTLER = 0;
var DEFAULT_NUM_STORIES_PER_CARD = 4;
var DEFAULT_NUM_STORIES_PER_NTK = 5;
var DEFAULT_NUM_MERCHANDISED_VIBES = 8;
var RELOAD_FREQ = 10; // in minutes
var DEFAULT_FOLLOWED_VIBES = {'a4e6cc20-f784-3169-8d99-2e22d369a550':1};

// visit history tracker
var VISIT_HISTORY = JSON.parse(localStorage.getItem('visithistory')) || [];

// this creates a first level user prompt (i.e. the thing that starts the convo?) dom object
var create_prompt = function(prompt_obj, theme_color) {
	var prompt = document.createElement('div');
	prompt.className = 'prompt';
	if(theme_color) prompt.style.borderColor = theme_color;
	// prompt metadata
	var card_meta = document.createElement('div');
	card_meta.className = 'card_meta';
	var author = document.createElement('div');
	author.className = 'card_author';
	author.innerHTML = '<div class="card_author_avatar"><img src="' + prompt_obj.author_img + '"/></div>' + '<div class="card_author_name">' + '<a target="_blank" href="userhistory.php?guid=' + prompt_obj.author_guid + '">' + prompt_obj.author_name + '</a>' + '</div>';
	card_meta.appendChild(author);
	
	// timestamp
	var timestamp = document.createElement('div');
	timestamp.className = 'card_timestamp';
	// comment time
	timestamp.innerHTML = prompt_obj.comment_relative_time + 'h';
	card_meta.appendChild(timestamp);
	prompt.appendChild(card_meta)
	// the premise of the comment
	if(prompt_obj.bot)	{
		// no!
	}
	else {
		var premise = document.createElement('div');
		premise.className = 'premise';
		premise.innerHTML = prompt_obj.text;
		prompt.appendChild(premise);
	}
	// engagement
	prompt.appendChild(create_engagement_meta(prompt_obj));

	return prompt;
}

// this creates a second level reply dom object
var create_riposte = function(riposte_obj, theme_color)	{
	var riposte = document.createElement('div');
	if(theme_color) riposte.style.borderColor = theme_color;

	riposte.className = 'riposte';
	// riposte metadata
	var riposte_meta = document.createElement('div');
	riposte_meta.className = 'card_meta';
	var riposte_author = document.createElement('div');
	riposte_author.className = 'card_author';
	riposte_author.innerHTML = '<div class="card_author_avatar"><img src="' + riposte_obj.author_img + '"/></div>' + '<div class="card_author_name">' + riposte_obj.author_name + '</div>';
	riposte_meta.appendChild(riposte_author);
	var riposte_timestamp = document.createElement('div');
	riposte_timestamp.className = 'card_timestamp';
	// comment time
	riposte_timestamp.innerHTML = riposte_obj.comment_relative_time + 'h';
	riposte_meta.appendChild(riposte_timestamp);
	riposte.appendChild(riposte_meta)

	// the premise of the comment
	var riposte_premise = document.createElement('div');
	riposte_premise.className = 'premise';
	riposte_premise.innerHTML = riposte_obj.text;
 	riposte.appendChild(riposte_premise);

	// engagement
	riposte.appendChild(create_engagement_meta(riposte_obj)); 	

 	return riposte;
}

// this creates the up / down / reply engagement info with counts
var create_engagement_meta = function(engagement_obj)	{
	var engagement = document.createElement('div');
	engagement.className = 'engagement';
	engagement.innerHTML = '&uarr; ' + engagement_obj.upvotes + '&nbsp; &nbsp; &nbsp; ' + '&darr; ' + engagement_obj.downvotes + '&nbsp; &nbsp; &nbsp; ' + '&#10150; ' + engagement_obj.replies;
	
	return engagement;
}

// this creates the context (e.g. the article) dom object
var create_context = function(context_obj, verbose, theme_color)	{
	if(verbose)	{
		var context = document.createElement('div');
		context.className = 'context verbose';
		context.innerHTML = '<a target="_blank" href="' + context_obj.context_meta.link + '">' + (context_obj.context_meta.img ? ('<img class="context_image" src="' + context_obj.context_meta.img + '"/>') : '') + '<div class="context_title">' + context_obj.context_meta.title + '</div>' + '<div class="context_source">' + context_obj.context_meta.provider + ' &bull; ' + context_obj.context_meta.content_relative_time + 'h' + '</div>' + '</a>';
	}
	else {
		// the context (the article)
		var context = document.createElement('div');
		context.className = 'context';
		context.style.background = '#eee';
		context.style.padding = '10px';
		context.innerHTML = '<div style="margin-left: 20px">' + context_obj.context_meta.vibe_name + ' &bull; ' + context_obj.context_meta.provider + ' &bull; ' + context_obj.context_meta.content_relative_time + 'h</div>' + '<a target="_blank" tabindex="-1" href="' + context_obj.context_meta.link + '">'  + '<div class="context_title" style="font-size: 16px !important; margin-top: 10px !important; margin-bottom: 10px !important">' + context_obj.context_meta.title + '</div>' + '</a>';
	}

	if(theme_color) {
		context.style.background = theme_color;
		context.style.color = '#fff';
	}

	return context;
}

// this function creates our standard top-level padded card construct
function create_cardstream_card_shell() {
	var vibe_card = document.createElement('div');
	vibe_card.style.background = 'white';
	// vibe_card.style.boxShadow = '0 0 10px 0 rgba(0,0,0,0.5)'
	vibe_card.style.padding = '10px';
	vibe_card.style.margin = '0 0 20px 0';
	vibe_card.style.perspective = '1000px';

	return vibe_card;	
}

// this function creates a user comment
var create_cardstream_comment_block_shell = function(postscommentsobj, theme_color) {	
	var comment_block = document.createElement('div');
	comment_block.className = 'cardstream_comment_block';
	comment_block.fontWeight = 'normal'
	comment_block.innerHTML = '<div style="color: #888; font-size: 11px; margin-bottom: 5px; vertical-align: middle">' + '<img style="width: 20px; height: 20px; border-radius: 10px; position: relative; margin-right: 6px" src="' + postscommentsobj.author_img + '"/>' + '<span style="position: relative; top: -6px">' + postscommentsobj.author_name + ' &bull; ' + ((postscommentsobj.comment_relative_time > 0) ? (postscommentsobj.comment_relative_time + 'h') : ('<span style="color: red">new</span>')) + '</span>' + '</div>' + '<div style="position: relative; margin-bottom: 20px; border-left: 5px solid ' + theme_color + '; padding: 0px 20px">' + postscommentsobj.text + '</div>';

	return comment_block;
};

// this function creates the individual vibe cards that exist in the cardstream
function create_vibe_card(obj) {
	console.log('function: create_vibe_card();');

	// shortcuts
	var vibe_id = obj.id;
	var vibe_name = obj.name;
	var vibe_posts = obj.posts;
	var vibe_comments = obj.comments;
	var vibe_postscomments = obj.postscomments;
	
	// which list should we use to render stuff?
	var selected_list = vibe_postscomments;

	// what's the theme for this vibe
	var theme_color = COLORS[vibe_id.charCodeAt(1) % COLORS.length];
	var secondary_color = SECONDARY_COLORS[vibe_id.charCodeAt(1) % COLORS.length];

	var is_ntk = vibe_id == '@NTKVIDEO' && (window.location.href.indexOf('ntk') == -1);
	var is_mega = (vibe_id == '@MEGASTREAMVIDEO') || (vibe_id == '@MEGASTREAM');

	var vibe_card = create_cardstream_card_shell();
	vibe_card.id = vibe_id;
	vibe_card.appendChild(create_cardstream_card_header_shell(vibe_name, theme_color, secondary_color));

	if(selected_list.length == 0) {
		var empty_message = document.createElement('div');
		empty_message.textAlign = 'center';
		empty_message.innerHTML = 'Nothing to see here lately.'
		empty_message.style.margin = '20px 0'
		vibe_card.appendChild(empty_message)
	}
	else {
		// use the selected list
		for(var j = 0; j < selected_list.length; j++)	{
			var vibe_story = document.createElement('div');
			vibe_story.className = 'cardstream_vibe_story';

			var post_meta;
			// first figure out which list we're using and set the post meta accordingly
			if(selected_list == vibe_postscomments) 
				post_meta = selected_list[j].context_meta;
			else 
				post_meta = selected_list[j];

			var has_thumbnail = post_meta.img;
			var has_vertical_thumbnail = has_thumbnail && (post_meta.imgw / post_meta.imgh == 9/16);
			var is_vertical_video = (post_meta.aspect == 0.56);
			has_vertical_thumbnail = is_vertical_video;
			var has_comment = false;

			// if there's a comment note it
			if(
				selected_list == vibe_postscomments && !selected_list[j].bot
				// && !has_vertical_thumbnail // disable comments for vertical videos for now
				&& !is_ntk // disable comments for ntk for now
				// && !is_mega // disable comments for mega videos for now
				// && selected_list[j].score > 0.97
			) {
				// this one has a comment
				var comment_block = create_cardstream_comment_block_shell(selected_list[j], theme_color);
				vibe_story.appendChild(comment_block);

				has_comment = true;
			}

			// skip ntks that are missing thumbs. should never happen
			if(is_ntk && !has_thumbnail) continue;

			vibe_story.style.margin = is_ntk ? '20px 0 20px 0' : (has_comment ? '20px -20px' : '20px 0');
			vibe_story.style.padding = has_comment ? '20px 20px' : '';
			vibe_story.style.background = has_comment ? '#f9f9f9' : '';
			vibe_story.style.position = 'relative';
			vibe_story.style.boxShadow = has_comment ? '0 0 3px 0px rgba(0,0,0,0.5) inset' : '';		

			// what url to go to when clicked?
			if(window.location.href.indexOf('useweblinks') > -1) {
				vibe_story.url = post_meta.content_url;
			}
			else {
				// vibe_story.url = post_meta.post_url; // post url
				vibe_story.url = 'http://www.yahoo.com/newsroom/vibes/newsroomish/' + post_meta.post_id.substring(0, 38) + '_c-' + post_meta.post_id.substring(80, 116) + post_meta.post_id.substring(77, 116); // mega-based post url (always uses web comments)
			}

			vibe_story.onclick = function() {
				window.open(this.url)
			}

			if(
				has_thumbnail
				// && !has_comment
			)	{
				var vibe_story_img = document.createElement('div');
				vibe_story_img.style.display = 'inline-block'
				vibe_story_img.className = 'vibe_story_img';
				vibe_story_img.style.borderRadius = is_ntk ? '10px' : '5px';
				vibe_story_img.style.width = is_ntk ? '100%' : (has_comment ? '46px' : '82px');
				vibe_story_img.style.height = is_ntk ? (Math.floor(180 + (Math.random() * 100)) + 'px') : (has_vertical_thumbnail ? (has_comment ? '84px' : '136px') : (has_comment ? '46px' : '82px'));
				vibe_story_img.style.margin = is_ntk ? '0px 0px 10px 0px' : '0';
				vibe_story_img.style.marginLeft = is_ntk ? '' : '';
				vibe_story_img.style.boxShadow = is_ntk ? '0 0 10px 0 gray' : ''; // dropp because of perf
				vibe_story_img.style.background = 'url(' + ((is_ntk || has_vertical_thumbnail) ? post_meta.img : post_meta.imgresolutions[0].url) + ') no-repeat center 25%';
				vibe_story_img.style.backgroundSize = 'cover'
				vibe_story_img.innerHTML = is_ntk ? '<div style="display: inline-block;color: white;width: 100%;vertical-align: top;position: absolute;top: -50px;right: 0px;padding: 0 20px;text-align: right;border-radius: 10px;font-size: 75px;opacity: 0.75; text-shadow: 0 0 10px #000">' + (j + 1) + '</div>' : '';
				vibe_story.appendChild(vibe_story_img);
			}
					
			var vibe_story_provider = document.createElement('div');
			vibe_story_provider.style.display = 'inline-block'
			vibe_story_provider.style.fontSize = '12px'
			vibe_story_provider.innerHTML = post_meta.provider_image ? ('<img style="height: 12px; position: relative; top: 1px" src="' + post_meta.provider_image + '"/>') : post_meta.provider;

			var vibe_story_timestamp = document.createElement('div');
			vibe_story_timestamp.style.display = 'inline-block'
			vibe_story_timestamp.style.fontSize = '12px'
			vibe_story_timestamp.innerHTML = '&nbsp; &bull; ' + (post_meta.content_relative_time == 0 ? ('<font style="color: red">new</font>') : (post_meta.content_relative_time > 23) ? (Math.floor(post_meta.content_relative_time / 24) + 'd') : (post_meta.content_relative_time + 'h')) + (vibe_story.url.indexOf('yahoo.com') == -1 ? '&nbsp; &bull; &nbsp; &rarr;' : '');

			var vibe_story_title = document.createElement('div');
			vibe_story_title.style.fontSize = is_ntk ? '30px' : has_vertical_thumbnail ? (has_comment ? '14px' : '24px') : (has_comment ? '13px' : '15px');
			vibe_story_title.style.fontWeight = is_ntk ? 'bold' : 'normal';
			vibe_story_title.style.color = is_ntk ? 'white' : (has_comment ? '#444' : '#222');
			vibe_story_title.style.webkitLineClamp = is_ntk ? '3' : (has_vertical_thumbnail ? '4' : (has_comment ? '2' : '3'));
			vibe_story_title.style.display = '-webkit-box';
			vibe_story_title.style.overflow = 'hidden';
			vibe_story_title.style.webkitBoxOrient= 'vertical';
			vibe_story_title.style.textShadow = is_ntk ? '1px 1px 10px black' : '';
			vibe_story_title.innerHTML = post_meta.title;

			var vibe_story_actions = document.createElement('div');
			vibe_story_actions.style.fontSize = '10px';
			vibe_story_actions.style.margin = '5px 0px';
			vibe_story_actions.style.color = theme_color;
			vibe_story_actions.innerHTML = post_meta.reaction_count ? (post_meta.reaction_count > 1 ? post_meta.reaction_count + ' reactions' : post_meta.reaction_count + ' reaction') : '' ;

			var vibe_story_meta = document.createElement('div');
			vibe_story_meta.style.paddingLeft = (!is_ntk && has_thumbnail) ? '10px' : '';
			vibe_story_meta.style.display = 'inline-block';
			vibe_story_meta.style.color = '#aaa';
			vibe_story_meta.style.width = (has_thumbnail) ? '70%' : '100%';
			vibe_story_meta.style.verticalAlign = 'top';

			if(is_ntk) {
				// vibe_story_meta.appendChild(vibe_story_provider)
				// vibe_story_meta.appendChild(vibe_story_timestamp)
				vibe_story_meta.appendChild(vibe_story_title)			
				// vibe_story_meta.appendChild(vibe_story_actions)
				vibe_story_img.style.position = 'relative';
				vibe_story_meta.style.position = 'absolute';
				vibe_story_meta.style.bottom = '0';
				vibe_story_meta.style.left = '0';
				vibe_story_meta.style.width = '100%';
				vibe_story_meta.style.padding = '50px 20px 15px 20px';
				vibe_story_meta.style.textAlign = 'left';
				vibe_story_meta.style.background = 'linear-gradient(rgba(0, 0, 0, 0), rgba(0,0,0,0.75))';
				vibe_story_meta.style.borderRadius = '10px';
				vibe_story_img.appendChild(vibe_story_meta);

				var TEMPERATURE_GRADIENT_COLORS = ['red', 'orange', 'yellow'];
				var TEMPERATURE_MESSAGES = ['Many news publishers are covering this story.', 'A few other major news coverage outlets are following this story.', 'This story is emerging.'];
				TEMPERATURE_INDEX = Math.floor(Math.random() * 3);
				
				var vibe_story_temperature = document.createElement('div');
				vibe_story_temperature.style.fontSize = '10px';
				vibe_story_temperature.style.marginBottom = '-10px'
				vibe_story_temperature.innerHTML = '<img style="width: 20px; height: 20px; background: -webkit-radial-gradient(' + TEMPERATURE_GRADIENT_COLORS[TEMPERATURE_INDEX] + ', white 75%, white)" src="https://d30y9cdsu7xlg0.cloudfront.net/png/151029-200.png" />' + '<span style="position: relative; top: -7px; left: 3px">' + TEMPERATURE_MESSAGES[TEMPERATURE_INDEX] + '</span>';
				vibe_story.appendChild(vibe_story_temperature);

				var vibe_substories = document.createElement('div');
				vibe_substories.innerHTML = '<div class="cardstream_vibe_story" style="margin: 20px 0px; position: relative;"><div class="vibe_story_img" style="display: inline-block; border-radius: 5px; width: 82px; height: 82px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; background: gray center 25% / cover no-repeat;"></div><div style="padding-left: 10px; display: inline-block; color: rgb(170, 170, 170); width: 70%; vertical-align: top;"><div style="display: inline-block; font-size: 12px;"><img style="height: 12px; position: relative; top: 1px" src="http://l.yimg.com/os/152/2012/04/21/image001-png_162613.png"></div><div style="display: inline-block; font-size: 12px;">&nbsp; &bull; <font style="">' + Math.floor(Math.random() * 8 + 1) + 'h</font></div><div style="font-size: 15px; font-weight: normal; color: rgb(34, 34, 34); -webkit-line-clamp: 3; display: -webkit-box; overflow: hidden; -webkit-box-orient: vertical;">Lorem ipsum dolor amet sil lorem ipsum dolor amet sil</div><div style="font-size: 10px; margin: 5px 0px; color: midnightblue;"></div></div></div><div class="cardstream_vibe_story" style="margin: 20px 0px; position: relative;"><div class="vibe_story_img" style="display: inline-block; border-radius: 5px; width: 82px; height: 82px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; background: gray center 25% / cover no-repeat;"></div><div style="padding-left: 10px; display: inline-block; color: rgb(170, 170, 170); width: 70%; vertical-align: top;"><div style="display: inline-block; font-size: 12px;"><img style="height: 12px; position: relative; top: 1px" src="http://l.yimg.com/os/152/2012/04/21/image001-png_162613.png"></div><div style="display: inline-block; font-size: 12px;">&nbsp; &bull; <font style="">' + Math.floor(Math.random() * 8 + 1) + 'h</font></div><div style="font-size: 15px; font-weight: normal; color: rgb(34, 34, 34); -webkit-line-clamp: 3; display: -webkit-box; overflow: hidden; -webkit-box-orient: vertical;">Lorem ipsum dolor amet sil lorem ipsum dolor amet sil</div><div style="font-size: 10px; margin: 5px 0px; color: midnightblue;"></div></div></div><div class="cardstream_vibe_story" style="margin: 20px 0px; position: relative;"><div class="vibe_story_img" style="display: inline-block; border-radius: 5px; width: 82px; height: 82px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; background: gray center 25% / cover no-repeat;"></div><div style="padding-left: 10px; display: inline-block; color: rgb(170, 170, 170); width: 70%; vertical-align: top;"><div style="display: inline-block; font-size: 12px;"><img style="height: 12px; position: relative; top: 1px" src="http://l.yimg.com/os/152/2012/04/21/image001-png_162613.png"></div><div style="display: inline-block; font-size: 12px;">&nbsp; &bull; <font style="">' + Math.floor(Math.random() * 8 + 1) + 'h</font></div><div style="font-size: 15px; font-weight: normal; color: rgb(34, 34, 34); -webkit-line-clamp: 3; display: -webkit-box; overflow: hidden; -webkit-box-orient: vertical;">Lorem ipsum dolor amet sil lorem ipsum dolor amet sil</div><div style="font-size: 10px; margin: 5px 0px; color: midnightblue;"></div></div></div>';
				vibe_story.appendChild(vibe_substories);


			} else {
				vibe_story_meta.appendChild(vibe_story_provider)
				vibe_story_meta.appendChild(vibe_story_timestamp)
				vibe_story_meta.appendChild(vibe_story_title)			
				vibe_story_meta.appendChild(vibe_story_actions)
				vibe_story.appendChild(vibe_story_meta);
			}

			// click behavior
			// vibe_story.onclick = function() {
				// do something
			// }

			// hide the leftovers until they hit read more
			if(
				(is_ntk && j > (DEFAULT_NUM_STORIES_PER_NTK)) // show X items in NTK
				|| 
				(!is_ntk && j > (DEFAULT_NUM_STORIES_PER_CARD - 1)) // show Y items in other cards
			) {
				vibe_story.style.display = 'none';
			}

			// append it to the card
			vibe_card.appendChild(vibe_story);
			// uncomment the following line to add the user contribution after the article title
			// if(has_comment) vibe_story.appendChild(comment_block);

		}
	}

	if(!is_ntk) {
		var vibe_card_extender = document.createElement('div');
		vibe_card_extender.style.textAlign = 'center';
		
		var vibe_card_more_button = document.createElement('button');
		vibe_card_more_button.style.border = 'none';
		vibe_card_more_button.style.background = 'none';
		vibe_card_more_button.style.color = '#666';
		vibe_card_more_button.style.padding = '10px 0px';
		vibe_card_more_button.innerHTML = selected_list.length > DEFAULT_NUM_STORIES_PER_CARD ? 'Read more' : 'That\'s all for now';
		// handler for when people ask for more
		if(selected_list.length > 3) {
			vibe_card_more_button.onclick = function() {
				var vibe_card = this.parentNode.parentNode;

				// unhide all the hidden stories
				for(var i = 0; i < vibe_card.childNodes.length; i++) {
					if(vibe_card.childNodes[i].className == 'cardstream_vibe_story') {
						vibe_card.childNodes[i].style.display = 'block';
					}
				}

				// hide the read more thinger
				this.parentNode.style.display = 'none';
			}
		}
		vibe_card_extender.appendChild(vibe_card_more_button);

		if(vibe_id.indexOf('@') == -1)	{
			var vibe_card_unsubscribe_button = document.createElement('button');
			vibe_card_unsubscribe_button.style.border = 'none';
			vibe_card_unsubscribe_button.style.border = 'none';
			vibe_card_unsubscribe_button.style.background = 'none';
			vibe_card_unsubscribe_button.style.color = '#666';
			vibe_card_unsubscribe_button.style.padding = '10px 0px';
			vibe_card_unsubscribe_button.innerHTML = '&nbsp; &bull; &nbsp; Unsubscribe';
			// handler for when people ask for more
			vibe_card_unsubscribe_button.vibe_id = vibe_id;
			vibe_card_unsubscribe_button.onclick = function() {
				// update followed vibes
				var vibes = JSON.parse(localStorage.getItem('myvibes')) || DEFAULT_FOLLOWED_VIBES;
				delete vibes[this.vibe_id];
				localStorage.setItem('myvibes', JSON.stringify(vibes));
				
				// hide the more actions thinger
				this.innerHTML = '&nbsp; &bull; &nbsp; Got it! We won\'t show this to you anymore.';

				// unfocus the button
				this.blur();
			}
			vibe_card_extender.appendChild(vibe_card_unsubscribe_button);
		}

		vibe_card.appendChild(vibe_card_extender);

	}

	// add friction
	if(is_ntk)	{
		var friction = document.createElement('div');
		friction.style.margin = '50px -10px 0 -10px';
		friction.style.padding = '50px';
		friction.style.background = 'green';
		friction.style.color = 'white';
		friction.innerHTML = '<h1 style="margin: 0 0 10px 0">Did you know?</h1><p>85% of statistics about people spending too much time on their phone are totally made up?</p><p>OK fine, that one\'s made up too, but still - you\'re all caught up! You can come back in the evening to get another dose of the news from every angle.</p><p>Still hungry for more? Keep scrolling!</p>';

		vibe_card.appendChild(friction);
	}

	return vibe_card;	
}

function load_vibe_list() {
	console.log('function: load_vibe_list(); gets the list of available vibes')
	// add script to head for jsonp to load the list of vibes that are available for analysis. this function will not get run on pages that parse amalgams and spit it out - it's just for pages that need a menu of vibes
	var scr = document.createElement('script');
	scr.src = 'caches/all_vibes.jsonp';
	document.head.appendChild(scr);
}

function load_vibe(id) {
	console.log('function: load_vibe(); getting details for the individual vibe, conditional on page params');
	// load an individual vibe. first check if we're evaluating all comments for each vibe or if we're looking at a pseudovibestream based on comments or if we're just spitting out the raw ranking
	if(window.location.href.indexOf('evaluate') > -1)	{
		// we're just evaluating all the comments we have for this vibe
		var scr = document.createElement('script');
		scr.src = 'caches/c_full_' + id + '.jsonp';
		document.head.appendChild(scr);
	}
	else if(window.location.href.indexOf('rawrank') > -1) {
		// spit out the raw list the backend gave us
		var scr = document.createElement('script');
		scr.src = 'caches/c_rawrank_' + id + '.jsonp';
		document.head.appendChild(scr);		
	}
	else {
		// we're looking at our new ranked pseudo-stream
		var scr = document.createElement('script');
		scr.src = 'caches/c_' + id + '.jsonp';
		document.head.appendChild(scr);
	}
}

function jsonp_parse_all_comments(obj) {
	console.log('function: jsonp_parse_all_comments(); handling the full list of comments' );
	document.title = 'evaluate all comments';		
	console.log(obj);
	
	// in this function we're getting as an input alllll the comments we found
	document.body.className = 'vibe_comment_evaluator';

	for(var i = 0; i < obj.length; i++)	{
		// skip bot posts
		if(obj[i].bot) continue;
		// skip reply-less comments if we're in threadsonly mode
		if(
			window.location.href.indexOf('threadsonly') > -1
			&& !obj[i].ripostes
		) continue;

	    var theme_color = COLORS[obj[i].context_meta.vibe_id.charCodeAt(1) % COLORS.length];

		var card = document.createElement('div');
		card.className = 'card';

		// the prompt (the comment)
		card.appendChild(create_prompt(obj[i], theme_color));
		// existing riposte
		if(
			obj[i].ripostes
			&& window.location.href.indexOf('noreplies') == -1
		)	{
			card.appendChild(create_riposte(obj[i].ripostes, theme_color));
		}		

		// the reply entry field
		// var reply = document.createElement('div');
		// reply.className = 'reply';
		// reply.innerHTML = '<textarea placeholder="' + (obj[i].bot ? ('Start the conversation') : ('Reply to ' + obj[i].author_name)) + '&hellip;"></textarea>';
		// card.appendChild(reply);

		// the context
		card.appendChild(create_context(obj[i], false, theme_color));

		document.body.appendChild(card);
	}	
}

function jsonp_parse_comment_list(obj) {
	document.title = 'evaluate vibe comments';	
	console.log('function: jsonp_parse_comment_list(); looks at all the comments from a particular vibe');
	console.log(obj);

	// in this function we're just evaluating all the comments for a given vibe
	document.body.className = 'vibe_comment_evaluator';

	console.log(obj)

	for(var i = 0; i < obj.length; i++)	{
		// TODO - don't need to do this repeatedly for the same vibe
		var theme_color = COLORS[obj[i].context_meta.vibe_id.charCodeAt(1) % COLORS.length];    
		// skip bot posts
		if(obj[i].bot) continue;

		// skip reply-less comments if we're in threadsonly mode
		if(
			window.location.href.indexOf('threadsonly') > -1
			&& !obj[i].ripostes
		) continue;

		// the card
		var card = document.createElement('div');
		card.className = 'card';
		
		// the prompt
		card.appendChild(create_prompt(obj[i], theme_color));
		
		// existing riposte
		if(
			obj[i].ripostes
			&& window.location.href.indexOf('noreplies') == -1
		)	{
			card.appendChild(create_riposte(obj[i].ripostes, theme_color));
		}		
		
		// the context (the article)
		card.appendChild(create_context(obj[i], false, theme_color));

		// the whitelist button
		var whitelist_div = document.createElement('div');
		whitelist_div.style.padding = '20px';
		whitelist_div.style.textAlign = 'center';
		var whitelist_button = document.createElement('button');
		whitelist_button.style.boxSizing = 'border-box';
		whitelist_button.style.background = theme_color;
		whitelist_button.style.padding = '20px';
		whitelist_button.style.color = 'white';
		whitelist_button.innerHTML = 'whitelist this comment for this vibe';
		whitelist_button.comment_data = obj[i];
		whitelist_button.onclick = function() {
			console.log(this.comment_data);
		}
		whitelist_div.appendChild(whitelist_button);
		// card.appendChild(whitelist_div);

		document.body.appendChild(card);
	}
}

function jsonp_parse_multi_posters(obj) {
	document.title = 'multi-posters';
	console.log('handler: multi-poster list NOT YET IMPLEMENTED');
	console.log(obj);
}

function jsonp_parse_amalgam(full_amalgam) {
	document.title = 'cardstream';	
	console.log('handler: amalgam cardstream');
	console.log(full_amalgam);
	
	// var parsing
	AMALGAM = full_amalgam; // store all this info in our superglobal
	ALL_VIBES = AMALGAM.cards; // another superglobal
	var obj = AMALGAM.cards; // the obj we'll parse here in this function

	// get followed vibes from localstorage
	var followed_vibes = JSON.parse(localStorage.getItem('myvibes')) || DEFAULT_FOLLOWED_VIBES;

	// styles
	document.body.style.background = '#fff';
	document.body.style.transitionDuration = '0.3s';

	// container for the main cardstream
	var cardstream_main = document.createElement('div');
	cardstream_main.style.position = 'relative';
	cardstream_main.style.transitionDuration = '0.3s';
	cardstream_main.id = 'cardstream_main';

	// first paint mine + trending
	for(var i = 0; i < obj.length; i++)	{
		var vibe_id = obj[i].id;
		var vibe_name = obj[i].name;
		var vibe_posts = obj[i].posts;
		var theme_color = COLORS[vibe_id.charCodeAt(1) % COLORS.length];

		var is_ntk = vibe_id == '@NTKVIDEO';
		// var is_mega = vibe_id == '@MEGASTREAMVIDEO';
		var is_mega = (vibe_id == '@MEGASTREAM' || vibe_id == '@MEGASTREAMVIDEO');
		var is_breaking = vibe_id == '@BREAKING';

		if(is_breaking) {
			// it's breaking news! it gets extra special handling
			var	breaking_card = document.createElement('div');
			breaking_card.style.fontSize = '36px';
			breaking_card.style.position = 'relative';
			breaking_card.style.padding = '50% 10px 50px 10px';
			breaking_card.style.color = 'white';
			breaking_card.style.backgroundColor = 'gray';
			// breaking_card.style.background = 'url(https://s.yimg.com/uu/api/res/1.2/wqnJSfOfa3viHAaifQUa7g--~B/Zmk9c3RyaW07aD0zODg7cHlvZmY9MDtxPTk1O3c9NzIwO3NtPTE7YXBwaWQ9eXRhY2h5b24-/https://media.zenfs.com/creatr-images/GLB/2017-12-20/c6510710-e5c0-11e7-970f-75cc8c9abb98_image-9208.cf.webp)';
			breaking_card.style.backgroundSize = 'cover';
			breaking_card.style.backgroundPosition = '50% 50%';
			breaking_card.style.marginBottom = '10px';
			breaking_card.style.boxShadow = '0 0 10px 0 gray';
			breaking_card.innerHTML = '<div style="background: linear-gradient(135deg, red, darkorange); padding: 10px 20px 10px 10px; margin-left: -10px; margin-bottom: 10px; display: inline-block; border-radius: 0 10px 10px 0; color: white; font-weight: bold; text-shadow: 1px 1px 10px black">' + obj[i].heading + '</div>' + '<div style="font-size: 18px; color: white; text-shadow: 1px 1px 10px black">' + obj[i].msg + '</div>';
			// for now, only append when explicitly requested
			if(
				true ||
				window.location.href.indexOf('breaking') > -1) cardstream_main.appendChild(breaking_card);
		}
		else if(
			is_ntk
			|| is_mega
		)	{
			// it's an NTK or a MEGASTREAM or a regular vibe
			cardstream_main.appendChild(create_vibe_card(obj[i]));
		}
		else if(followed_vibes[vibe_id]) {
			// it's a followed vibe
			cardstream_main.appendChild(create_vibe_card(obj[i]));
		}
	}

	// now paint the suggested vibes carousel
	cardstream_main.appendChild(create_suggested_vibes_card(followed_vibes));

	// TODO now add suggested vibes to be followed

	// add the main cardstream to body
	document.body.appendChild(cardstream_main);

	// re-jigger the cardstream to make trending come last
	for(var i = 0; i < cardstream_main.childNodes.length; i++) {
		// not yet
	}

	// do left and right tabs
	if(window.location.href.indexOf('multinav') > -1) {
		// container for the cardstream explore
		var cardstream_explore = document.createElement('div');
		cardstream_explore.style.position = 'absolute';
		cardstream_explore.style.top = 0;
		cardstream_explore.style.left = 0;
		cardstream_explore.style.width = '100%';
		cardstream_explore.style.transitionDuration = '0.3s';
		cardstream_explore.style.transform = 'translate3d(100%, 0, 0)';
		cardstream_explore.id = 'cardstream_explore';
		var explore_card = create_cardstream_card_shell();
		explore_card.appendChild(create_cardstream_card_header_shell('Explore'));
		
		var explore_content = AMALGAM.explore;
		for(var i = 0; i < explore_content.length; i++)	{
			console.log(explore_content)

			if(explore_content[i].type == 'comment') {
				var vibe_story = document.createElement('div');
				vibe_story.style.position = 'relative';
				vibe_story.appendChild(create_cardstream_comment_block_shell(explore_content[i].blob, 'gray'));				

				explore_card.appendChild(vibe_story)
			}
		}
		cardstream_explore.appendChild(explore_card);
		// add the explore to the body
		document.body.appendChild(cardstream_explore);

		// container for the cardstream profile
		var cardstream_profile = document.createElement('div');
		cardstream_profile.style.position = 'absolute';
		cardstream_profile.style.top = 0;
		cardstream_profile.style.left = 0;
		cardstream_profile.style.width = '100%';
		cardstream_profile.style.transitionDuration = '0.3s';
		cardstream_profile.style.transform = 'translate3d(-100%, 0, 0)';
		cardstream_profile.id = 'cardstream_profile';
		var profile_card = document.createElement('div');
		profile_card.innerHTML = '<div style="text-align: center; width: 100%; padding-top: 20px"><div style="background: url(http://dandyheadshots.com/wp-content/uploads/2016/12/jackie-o-keefe-of-trueu-indianapolis-headshot-photography-by-josh-humble-2-2.jpg) no-repeat center center; background-size: cover; width: 350px; height: 350px; display: inline-block; border-radius: 175px; border: 10px solid white; box-shadow: 0 0 10px 0 gray"></div></div><div style="font-size: 30px; text-align: center; margin: 10px">Betty Fakename</div>';
		cardstream_profile.appendChild(profile_card);
		// add the profile to the body
		document.body.insertBefore(cardstream_profile, document.body.childNodes[0]);

		// now create the bottom bar
		var cardstream_nav = document.createElement('div');
		cardstream_nav.id = 'cardstream_nav';
		cardstream_nav.style.transitionDuration = '0.3s'
		cardstream_nav.style.position = 'fixed';
		cardstream_nav.style.bottom = '0';
		cardstream_nav.style.left = '0';
		cardstream_nav.style.width = '100%';
		cardstream_nav.style.height = '40px';
		cardstream_nav.style.lineHeight = '40px';	
		cardstream_nav.style.boxShadow = '0 0 10px 0 gray';
		cardstream_nav.style.background = 'rgba(255,255,255,0.75)';
		cardstream_nav.innerHTML = '<div style="height: 40px; width: 33%; text-align: center; display: inline-block"><img style="transform: scale(0.7); height: 100%" src="https://s.yimg.com/cv/ae/default/171219/icons8-user-male-50.png"/></div><div style="height: 40px; width: 34%; text-align: center; display: inline-block"><img style="transform: scale(0.7); height: 100%" src="https://s.yimg.com/cv/ae/default/171219/icons8-home-50.png"/></div><div style="height: 40px; width: 33%; text-align: center; display: inline-block"><img style="transform: scale(0.7); height: 100%" src="https://s.yimg.com/cv/ae/default/171219/icons8-search-50.png"/></div>';
		// https://s.yimg.com/cv/ae/default/171219/icons8-contacts-50.png
		// make the middle selected
		cardstream_nav.childNodes[1].style.background = 'linear-gradient(135deg, #eee, #ccc)';
		// click handler for each tab
		for(var i = 0; i < cardstream_nav.childNodes.length; i++) {
			cardstream_nav.childNodes[i].onclick = function() {
				// find out which button i am
				var me;
				for(var i = 0; i < this.parentNode.childNodes.length; i++)	{
					if(this == this.parentNode.childNodes[i]) me = i;
				}

				for(var i = 0; i < document.body.childNodes.length; i++)	{
					// skip the navbar
					if(document.body.childNodes[i] == this.parentNode) {
						continue;
					}

					if(i == me) {
						this.parentNode.childNodes[i].style.background = 'linear-gradient(135deg, #eee, #ccc)';
					}
					else {
						this.parentNode.childNodes[i].style.background = '';	
					}

					// move the right amount
					document.body.childNodes[i].style.transform = 'translate3d(' + ((i - me) * 100) + '%, 0, 0)';
				}

				window.scrollTo({
					'behavior' : 'smooth',
					'left' : '0',
					'top' : '0'
				});
			}
		}
		document.body.appendChild(cardstream_nav);
		// TODO make the nav disappear sometimes
		window.CARDSTREAM_LAST_SCROLL_POSITION = 0;
		document.addEventListener("scroll", function(event) {
			// check if we're plannign on doing something already; if so, clear it
			if(window.CARDSTREAM_SCROLL_THROTTLER_TIMEOUT)	{
			 	window.clearTimeout(window.CARDSTREAM_SCROLL_THROTTLER_TIMEOUT);
			}

			// set a new timeout to handle things
			window.CARDSTREAM_SCROLL_THROTTLER_TIMEOUT = window.setTimeout(function() {
				document.getElementById('cardstream_nav').style.transform =	(window.CARDSTREAM_LAST_SCROLL_POSITION < document.body.scrollTop) ? 'translateY(100%)' : '';

				window.CARDSTREAM_LAST_SCROLL_POSITION = document.body.scrollTop;

				console.log('fire')
			}, 100);
		});
	}

	// do the visit gamification thing now
	frequency_tracker_message();
}

function jsonp_parse_threadlines(threadlines_obj)	{
	THREADLINES = threadlines_obj;

	var optionlist = '';
	optionlist += '<option value="true">[everything]</option>';
	optionlist += '<option value="text.match(/#metoo/)">#metoo</option>';
	optionlist += '<option selected value="title.match(/\\Walexa\\W/) || summary.match(/\\Walexa\\W/) || summary.match(/\\Wgoogle assistant\\W/) || title.match(/\\Wgoogle assistant\\W/)">alexa and assistant</option>'
	optionlist += '<option value="text.match(/\\Wbollywood\\W/)">bollywood</option>';
	optionlist += '<option value="(text.match(/\\Wford motor\\W/) || text.match(/\\Wgeneral motors\\W/) || text.match(/\\Whonda\\W/) || text.match(/\\Wnissan\\W/) || text.match(/\\Wvag\\W/)) && provider != \'mercury news\'">detroit and foreign auto</option>';
	optionlist += '<option value="text.match(/\\Whealth care\\W/)">health care</option>';
	optionlist += '<option value="provider == \'last night now\'">last night now</option>';
	optionlist += '<option value="provider == \'last night now\' && text.indexOf(\'bachelor\') == -1">last night now, but no bachelor</option>';
	optionlist += '<option value="text.match(/\\Wmachine learning\\W/)">machine learning</option>';
	optionlist += '<option value="text.match(/\\Wmachine learning\\W/) || text.match(/\\Wartificial intelligence\\W/)">machine learning or artificial intelligence</option>';
	optionlist += '<option value="!text.match(/\\Wpolitics\\W/) && topic != \'politics\' && !text.match(/trump\/)">politics-free and trump-free news feed</option>';
	optionlist += '<option value="(text.match(/\\Wpolitics\\W/) || topic == \'politics\') && !text.match(/trump\/) && provider != \'yahoo news video\'">politics, no trump, no yahoo news video</option>';
	optionlist += '<option value="aspect == 0.56">vertical videos</option>';
	optionlist += '<option value="aspect == 0.56 && !text.match(/\\Wtrump\\W/)">vertical videos not about trump</option>';
	optionlist += '<option value="aspect == 0.56 && !provider.match(/yahoo/)">vertical videos not from yahoo</option>';

	document.body.innerHTML = '<form id="query"><select id="threadlines_preselects" style="margin: 10px 10%; width: 80%; background: white; border: 1px outset">' + optionlist + '</select><textarea id="threadlines_conditions" style="width: 80%; margin: 10px 10%" rows=10>title.match(/\\Walexa\\W/) || summary.match(/\\Walexa\\W/) || summary.match(/\\Wgoogle assistant\\W/) || title.match(/\\Wgoogle assistant\\W/)</textarea><div style="text-align: center"><input type="button" id="query_submit" value="go" style="border: 2px outset; margin: 10px"/></div></form><div id="stream"></div>';

	document.getElementById('threadlines_preselects').onchange = function() {
		document.getElementById('threadlines_conditions').value = this.value;
		document.getElementById('query_submit').click();
	}
	

	document.getElementById('query_submit').onclick = function() {
		console.log('query handling');

		document.getElementById('stream').innerHTML = '';

		var condition = document.getElementById('threadlines_conditions').value
		console.log('condition:');
		console.log(condition);

		var matched_stories = [];

		// fake news
		// (text.match(/\Wfake news\W/))
		// science videos
		// type == 'video_link' && topic == 'science'
		// vertical videos
		// aspect == 0.56


		for(uuid in THREADLINES)	{
			post = THREADLINES[uuid];
			provider = post['provider'] ? post['provider'].toLowerCase() : '';
			aspect = post['aspect'];
			type = post['content_type'].toLowerCase();
			reactions = post['reaction_count'];
			topic = post['vibe_name'].toLowerCase();
			title = post['title'] ? post['title'].toLowerCase() : '';
			summary = post['summary'] ? post['summary'].toLowerCase() : '';
			text = title + ' ' + summary;
			imgurl = post['img'];

			if(
				(
					provider != 'pr newswire' &&
					provider != 'business wire' &&
					provider != 'globenewswire'					
				) &&
				(eval(condition))
			) {
				matched_stories.push(post);
			}
		}

		for(var i = 0; i < matched_stories.length; i++)	{
			for(var j = i + 1; j < matched_stories.length; j++)	{
				if(matched_stories[i].content_relative_time > matched_stories[j].content_relative_time)	{
					tmp = matched_stories[i];
					matched_stories[i] = matched_stories[j];
					matched_stories[j] = tmp;
				}
			}
		}

		console.log('matched: ' + matched_stories.length)
		console.log(matched_stories)

		for(var i = 0; i < matched_stories.length; i++)	{
			var post_div = document.createElement('div');
			post_div.innerHTML = '<div class="th_topic" style="font-size: 8px">' +matched_stories[i].vibe_name + '</div>' + '<div class="th_title" style="font-size: 8px">' + matched_stories[i].content_relative_time + 'h</div>' + '<div class="th_title" style="font-size: 20px"><a href="' + matched_stories[i].content_url + '">' + matched_stories[i].title + '</a></div>' + '<div class="th_provider" style="font-size: 10px">' + matched_stories[i].provider + '</div>' + '<div class="th_summary" style="font-size: 12px">' + matched_stories[i].summary + '</div>' + '<br/><br/>';

			document.getElementById('stream').appendChild(post_div);
		}

		return false;
	}
}

function create_cardstream_card_header_shell(header_text, theme_color, secondary_color) {
	if(theme_color && secondary_color) {
		// it's passed in!
	}
	else {
		theme_color = COLORS[header_text.charCodeAt(0) % COLORS.length]
		secondary_color = SECONDARY_COLORS[header_text.charCodeAt(0) % COLORS.length]
	}

	var card_header_container = document.createElement('div');
	card_header_container.style.textAlign = 'left';

	var card_header = document.createElement('h1');
	card_header.innerHTML = header_text + '';
	card_header.style.margin = '0';
	card_header.style.display = 'inline-block'
	card_header.style.paddingBottom = '10px'
	card_header.style.marginBottom = '0px'
	card_header.style.fontSize = '40px'
	card_header.style.textAlign = 'left'
	card_header.style.borderBottom = '0px solid gray'
	card_header.style.borderColor = secondary_color;
	card_header.style.background = '-webkit-linear-gradient(135deg, ' + secondary_color + ', ' + theme_color + ')';
	card_header.style.webkitBackgroundClip = 'text';
	card_header.style.webkitTextFillColor= 'transparent';

	card_header_container.appendChild(card_header)

	return card_header_container;
}

function create_suggested_vibes_card(followed_vibes) {
	var theme_color = COLORS["Add to your Newsroom".charCodeAt(1) % COLORS.length]
	var secondary_color = SECONDARY_COLORS["Add to your Newsroom".charCodeAt(1) % COLORS.length]
	var suggested_vibes = document.createElement('div');
	suggested_vibes.style.background = 'white';
	// suggested_vibes.style.boxShadow = '0 0 10px 0 rgba(0,0,0,0.5)'
	suggested_vibes.style.padding = '10px';
	suggested_vibes.style.margin = '10px 0';
	
	var card_header = create_cardstream_card_header_shell('Get more stories', theme_color, secondary_color);
	suggested_vibes.appendChild(card_header);
	
	var merchandised_vibes = 0;
	var attempted_selections = 0;
	var merchandised_vibes_list = {};

	// show all vibes. note that default sort is in order of most recently updated
	for(var i = 0; (i < ALL_VIBES.length) /*&& (merchandised_vibes < 6)*/ && attempted_selections < 1000; i++)	{
		attempted_selections++;

		// var random_index = Math.floor(Math.random() * ALL_VIBES.length);
		var random_index = i;

		// check if i already followed it
		if(followed_vibes[ALL_VIBES[random_index].id]) continue;

		// skip specials like NTK and megastream
		if(ALL_VIBES[random_index].id.indexOf('@') > -1) continue;

		// skip broken meta
		if(ALL_VIBES[random_index].meta === null) continue;

		// see if we did it already
		if(merchandised_vibes_list[ALL_VIBES[random_index].id]) continue;		

		// OK WE'RE GONNA DO IT

		// note we did it already
		merchandised_vibes_list[ALL_VIBES[random_index].id] = true;

		// things to keep track of
		var vibe_id = ALL_VIBES[random_index].id;
		var vibe_name = ALL_VIBES[random_index].name;
		var vibe_desc = ALL_VIBES[random_index].meta ? ALL_VIBES[random_index].meta.description : 'Tap to read more!';
		var vibe_img = ALL_VIBES[random_index].meta ? ALL_VIBES[random_index].meta.image.originalUrl : '';
		var vibe_subs = ALL_VIBES[random_index].meta ? ALL_VIBES[random_index].meta.userSubscriberCount : '?';
		var theme_color = COLORS[vibe_id.charCodeAt(1) % COLORS.length]
		
		var vibe_card = document.createElement('div');
		vibe_card.className = 'merchandised_vibe';
		vibe_card.style.width = '50%';
		vibe_card.style.verticalAlign = 'top';
		vibe_card.style.display = 'inline-block';
		vibe_card.style.color = '#222';
		vibe_card.innerHTML = '<div style="position: relative; line-height: 18px; height: 220px; text-align: left; font-weight: bold; vertical-align: top; border-radius: 10px; margin: 10px 10px 0 0; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; padding: 140px 10px 10px 10px; display: -webkit-box; background: -webkit-linear-gradient(135deg, #333, ' + theme_color + '); -webkit-background-clip: text; -webkit-text-fill-color: transparent">' + /*'<img style="width: 100%" src="' + vibe_img + '" />' + */ '<div style="position: absolute; top: 0; left: 0; width: 100%; height: 130px; margin: 0; background-size: cover; background-position: 50% 50%; background-image: url(' + ALL_VIBES[random_index].meta.image.resolutions[0].url + ');"></div>' + '<div>' + vibe_name + '</div>' + '<div style="font-weight: normal; text-align: left">' + (vibe_desc || 'Tap to read more!') + '</div>' + '<div style="height: 15px; position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(rgba(255,255,255,0), white); height: 50px"></div>' + '<div style="position: absolute; top: 0; right: 0; -webkit-text-fill-color: white; box-sizing: border-box; border: 2px solid white; border-radius: 10px; width: 65px; height: 20px; text-align: center; line-height: 16px; font-size: 10px; vertical-align: middle; margin: 10px; background: rgba(0,0,0,0.25);">+ FOLLOW</div>' + '</div>';
		vibe_card.firstChild.vibe_id = vibe_id;
		vibe_card.firstChild.onclick = function() {
			this.style.webkitBackgroundClip = '';
			this.parentNode.style.color = 'white';
			this.style.webkitTextFillColor = '';

			ui_add_vibe_card(this.vibe_id);

			var vibes = JSON.parse(localStorage.getItem('myvibes')) || DEFAULT_FOLLOWED_VIBES;
			vibes[this.vibe_id] = 1;
			localStorage.setItem('myvibes', JSON.stringify(vibes));
		}
		
		suggested_vibes.appendChild(vibe_card);

		// hide more than X
		if(merchandised_vibes > (DEFAULT_NUM_MERCHANDISED_VIBES -1)) {
			vibe_card.style.display = 'none';
		}
		else {
			merchandised_vibes++;
		}

	}

	// empty message
	if(merchandised_vibes == 0)	{
		var empty_message = document.createElement('div');
		empty_message.innerHTML = 'You\'ve exhausted our universe!';
		empty_message.style.margin = '20px 0'
		suggested_vibes.appendChild(empty_message)
	}

	// show more?
	var vibe_card_extender = document.createElement('div');
	vibe_card_extender.style.textAlign = 'center';
	vibe_card_extender.style.padding = '0 10px';

	
	var vibe_card_more_button = document.createElement('button');
	vibe_card_more_button.style.border = 'none';
	vibe_card_more_button.style.background = 'none';
	vibe_card_more_button.style.color = '#666';
	vibe_card_more_button.style.padding = '10px 0px';
	vibe_card_more_button.innerHTML = merchandised_vibes == DEFAULT_NUM_MERCHANDISED_VIBES ? 'Show more' : 'That\'s all for now';
	// handler for when people ask for more
	if(merchandised_vibes == DEFAULT_NUM_MERCHANDISED_VIBES) {
		vibe_card_more_button.onclick = function() {
			var vibe_card = this.parentNode.parentNode;

			// unhide all the hidden stories
			for(var i = 0; i < vibe_card.childNodes.length; i++) {
				if(vibe_card.childNodes[i].className == 'merchandised_vibe') {
					vibe_card.childNodes[i].style.display = 'inline-block';
				}
			}

			// hide the read more thinger
			this.parentNode.style.display = 'none';
		}
	}
	vibe_card_extender.appendChild(vibe_card_more_button);

	suggested_vibes.appendChild(vibe_card_extender);	

	return suggested_vibes;	
}

function ui_add_vibe_card(vibe_id) {
	console.log('adding an explicit follow');

	for(var i = 0; i < AMALGAM.cards.length; i++)	{
		if(vibe_id == AMALGAM.cards[i].id)	{
			// add it!
			var vibe_card = create_vibe_card(AMALGAM.cards[i]);
			document.getElementById('cardstream_main').insertBefore(vibe_card, document.getElementById('cardstream_main').lastChild);
			window.scrollTo({
				'behavior' : 'smooth',
				'left' : '0',
				'top' : vibe_card.offsetTop
			});
		}
	}
}

function jsonp_parse_vibes(obj)	{
	document.title = 'vibe list';	
	console.log('function: jsonp_parse_vibes(); handles the vibe list');
	console.log(obj);

	// store it in the global
	ALL_VIBES = obj;

	if(window.location.href.indexOf('multiposters') > -1)	{
		document.body.innerHTML = '';

		console.log('config: multiposter evaluation!');
		var scr = document.createElement('script');
		scr.src = 'caches/multi_posters.jsonp';
		document.head.appendChild(scr);

		// ^ this is gonna end up calling: jsonp_parse_multi_posters
	}
	else {
		// here we're just handling the list of vibes - spit em out as a menu
		for(var i = 0; i < ALL_VIBES.length; i++)	{
			var vibe_button = document.createElement('div');
			vibe_button.className = 'vibe_button';
			vibe_button.id = ALL_VIBES[i].id;
			vibe_button.name = ALL_VIBES[i].name;
			vibe_button.innerHTML = ALL_VIBES[i].name;
			vibe_button.onclick = function() {
				document.body.innerHTML = '<h1 class="vibe_header">' + this.name + '</h1>';
				load_vibe(this.id);
			}

			document.body.appendChild(vibe_button);
		}
	}	

}

function jsonp_parse_posts(obj) {
	document.title = window.location.href.indexOf('rawrank') > -1 ? 'raw ranked new vibe stream' : 'new vibe stream';
	console.log('function: jsonp_parse_posts(); new vibe stream or rawranked vibe stream');
	console.log(obj);

	// this function tries our hand at a new vibe stream constructed by pseudoposts from comments
	for(var i = 0; i < obj.length; i++)	{
		// TODO - don't need to do this each time
		var theme_color = COLORS[obj[i].context_meta.vibe_id.charCodeAt(1) % COLORS.length];

		// the card
		var card = document.createElement('div');
		card.className = 'card';

		// the context (the article) and then the second param is verbose or not
		card.appendChild(create_context(obj[i], true));

		// the prompt (comment?)
		if(!obj[i].bot)	{
			var prompt = create_prompt(obj[i], theme_color);
			card.appendChild(prompt);
		}
	
		// ripostes
		// if(obj[i].ripostes)	{
			// card.appendChild(create_riposte(obj[i].ripostes));
		// }

		// the reply entry field
		// var reply = document.createElement('div');
		// reply.className = 'reply';
		// reply.innerHTML = '<textarea placeholder="' + (obj[i].bot ? ('Start the conversation') : ('Reply to ' + obj[i].author_name)) + '&hellip;"></textarea>';
		// card.appendChild(reply);

		document.body.appendChild(card);
	}
}

// function for auto refreshing the backend
var reload_backend = function() {
	console.log('starting backend reload');
	var scr_elem = document.createElement('script');
	scr_elem.src = 'newvibesbot.php?rnad=' + Math.random();
	document.head.appendChild(scr_elem);

	// call me again in RELOAD_FREQ minutes
	setTimeout(reload_backend, RELOAD_FREQ * 60000);
}
// start the autoreloader if it's been requested
if(
	window.location.href.indexOf('autoreload') > -1
) {
	console.log('starting autoreloads');
	setTimeout(reload_backend, RELOAD_FREQ * 60000);
}

// user frequency tracker
// VISIT_HISTORY.push()
function frequency_tracker_update() {
	// get the number of minutes since the unix epoch
	var now = Math.floor(new Date().getTime() / 1000 / 60);

	var last_minute = 0;
	var last_day = 0;
	var last_hour = 0;
	var last_week = 0;
	var last_month = 0;
	
	for(var i = 0; i < VISIT_HISTORY.length; i++)	{
		var old_timestamp = VISIT_HISTORY[i];

		if((now - old_timestamp) < (1))	{
			last_minute++;
		}
		if((now - old_timestamp) < (60))	{
			last_hour++;
		}
		if((now - old_timestamp) < (60 * 24))	{
			last_day++;
		}
		if((now - old_timestamp) < (60 * 24 * 7))	{
			last_week++;
		}
		if((now - old_timestamp) < (60 * 24 * 30))	{
			last_month++;
		}
	}

	// add this visit to the log
	VISIT_HISTORY.push(now);

	// truncate visit history to 100 visits
	while(VISIT_HISTORY.length > 100) {
		VISIT_HISTORY.shift()
	};

	// localstorage.setItem('')
	localStorage.setItem('visithistory', JSON.stringify(VISIT_HISTORY));

	var freq_log = ({
		'in the last minute' : last_minute,
		'in the last hour' : last_hour,
		'in the last day' : last_day,
		'in the last week' : last_week,
		'in the last month' : last_month
	});

	return freq_log;
}
FREQUENCY_LOG = frequency_tracker_update();
console.log(FREQUENCY_LOG);

// messaginng system
function frequency_tracker_message()	{
	// all these are NOT INCLUDING THIS VISIT
	var visits_thisday = FREQUENCY_LOG['in the last day'];
	var visits_thisweek = FREQUENCY_LOG['in the last week'];
	var visits_thismonth = FREQUENCY_LOG['in the last month'];

	var show_message = function(message_to_show) {
		var message_div = document.createElement('div');
		message_div.id = 'message_div';
		message_div.style.position = 'fixed';
		message_div.style.bottom = '0';
		message_div.style.left = '0';
		message_div.style.width = '90%';
		message_div.style.margin = '5%';
		message_div.style.padding = '10px';
		message_div.style.boxShadow = '0 0 10px 0 #ccc';
		message_div.style.boxSizing = 'border-box';
		message_div.style.background = 'lightgreen';
		message_div.style.borderRadius = '5px';
		message_div.style.opacity = '0';
		message_div.style.transitionDuration = '0.5s';
		message_div.style.transform = 'scale(0.1)';
		message_div.innerHTML = message_to_show + '<div style="font-size: 6px; margin-top: 6px">scroll to dismiss this message</div>';

		document.body.appendChild(message_div);

		setTimeout(function() {
			document.getElementById('message_div').style.opacity = 1;
			document.getElementById('message_div').style.transform = 'scale(1)';
		}, 1);

		window.setTimeout(message_clearer, 1000)
	}

	if(visits_thismonth == 0)	{
		show_message('welcome to newsroomish!<br/><br/>get just what you need to know right up here at the top, and then keep going down to get more news.<br/><br/>if you\'re feeling daring, follow a storyline to get updates on it every time you come back. don\'t worry, you can always unfollow!<br/>');
	}
	else if(visits_thisday == 0)	{
		show_message('good for you, checking in today! enjoy your taste of the top stories.');		
	}
	else if(visits_thisday == 2)	{
		show_message('wow, you\'re staying really informed! you\'ve checked in more than ' + (Math.floor(Math.random() * 50) + 50) + '% of the newsroomish audience today. keep it up!');		
	}
	else if(visits_thisday == 4)	{
		show_message('you just keep coming back for more! you\'ve checked in more than ' + (Math.floor(Math.random() * 30) + 70) + '% of the newsroomish audience today. keep it up!');		
	}
	else if(visits_thisweek == 0)	{
		show_message('welcome back! we\'ve missed you. more than ' + (Math.floor(Math.random() * 50) + 50) + '% of the newsroomish audience has showed up since the last time we saw you. go ahead and get caught up on your news now, and don\'t be such a stranger!');				
	}
	else if(visits_thisweek == 6)	{
		show_message('welcome back! you\'re getting to be a regular around here. check out the big brains on you!');				
	}
	else if(visits_thisweek == 12)	{
		show_message('daaaaaaaaaamn you on fire! we\'ve seen you more than ' + (Math.floor(Math.random() * 50) + 50) + '% of the audience in the last week! keep up the good work.');				
	}
	else if(window.location.href.indexOf('force_message') > -1) {
		show_message('forced message here');
	}
}

// this next function clears messages once you scroll
var message_clearer = function() {
	if(!document.getElementById('message_div')) return;

	if(document.body.scrollTop == 0) {
		window.setTimeout(message_clearer, 1000);
	}
	else {
		document.getElementById('message_div').style.opacity = '0';
	}
}

// void "main"
document.addEventListener("DOMContentLoaded", function(event) {
	// asked to clear out storage?
	if(window.location.href.indexOf('clearlocalstorage') > -1)	{
		localStorage.clear();
	}

	// looking at full comment list?
	if(window.location.href.indexOf('allcomments') > -1)	{
		document.body.innerHTML = '';

		console.log('fetching allcomments')
		var scr = document.createElement('script');
		scr.src = 'caches/c_allvibes.jsonp';
		document.head.appendChild(scr);
	}
	// special prototype for card streams?
	else if(window.location.href.indexOf('cardstream') > -1) {
		document.body.innerHTML = '';

		console.log('config: cardstream');
		var scr = document.createElement('script');
		scr.src = 'caches/amalgam.jsonp?rand=' + Math.random();
		document.head.appendChild(scr);
	}
	else if(window.location.href.indexOf('threadlines') > -1) {
		document.body.innerHTML = '';

		console.log('config: threadlines');
		var scr = document.createElement('script');
		scr.src = 'caches/threadlines.jsonp?rand=' + Math.random();
		document.head.appendChild(scr);
	}
	else {
		// just get the list of vibes we've got, we'll figure out what we're doing after
		load_vibe_list();
	}
});
</script>

</html>